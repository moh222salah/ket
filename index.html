<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="نظام تتبع المانجو الكيت المتقدم - تتبع مباشر للمزارع والأسعار والإنتاجية">
    <meta name="keywords" content="مانجو كيت, تتبع المزارع, أسعار المانجو, الزراعة المصرية">
    <meta name="author" content="نظام تتبع المانجو الكيت">
    
    <title>🥭 نظام تتبع المانجو الكيت المتقدم | مصر</title>
    <meta name="theme-color" content="#2b9348">
    
    <!-- أيقونة الموقع -->
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2909/2909768.png" type="image/png">
    
    <!-- خطوط Google - Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- مكتبة Font Awesome للأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- مكتبة Leaflet للخرائط التفاعلية -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Tailwind CSS عبر CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js لعرض الرسوم البيانية -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- مكتبة Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    




    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #001ea1 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #060e74 0%, #ffffff 100%);
            --success-gradient: linear-gradient(135deg, #ffffff 0%, #101687 100%);
            --warning-gradient: linear-gradient(135deg, #ffffff 0%, #000000 100%);
            --danger-gradient: linear-gradient(135deg, #ffffff 0%, #032f85 100%);
            --search-gradient: linear-gradient(135deg, #ffffff 0%, #18067e 100%);
            --area-gradient: linear-gradient(135deg, #ffffff 0%, #000341 100%);
            --dark-bg: #0a0e1a;
            --darker-bg: #070b15;
            --card-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            --text-accent: #f9f9f9;
            --shadow-glow: 0 25px 50px rgba(0, 0, 0, 0.4);
            --input-bg: rgba(255, 255, 255, 0.1);
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-blue: #00d4ff;
            --accent-green: #00ff88;
            --accent-orange: #ff9800;
            --accent-red: #ff6b6b;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.2);
            --shadow-heavy: rgba(0, 0, 0, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            line-height: 1.6;
        }
        
        /* خلفية متحركة متقدمة */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 15% 25%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 85% 75%, rgba(118, 75, 162, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 242, 254, 0.05) 0%, transparent 70%),
                linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
            animation: backgroundFlow 20s ease-in-out infinite;
            z-index: -1;
        }
        
        @keyframes backgroundFlow {
            0%, 100% { 
                background-position: 0% 0%, 100% 100%, 50% 50%;
                filter: hue-rotate(0deg);
            }
            50% { 
                background-position: 100% 100%, 0% 0%, 25% 75%;
                filter: hue-rotate(30deg);
            }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        /* رأس الصفحة */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            padding: 40px 0;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -30%;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 200px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.3;
            z-index: -1;
        }
        
        .main-title {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 900;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            animation: title-glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes title-glow {
            from { filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.5)); }
            to { filter: drop-shadow(0 0 20px rgba(0, 255, 136, 0.8)); }
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 300;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* البطاقات العامة */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 30px var(--shadow-light);
            margin-bottom: 25px;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px var(--shadow-medium);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .card:hover::before {
            left: 100%;
        }
        
        /* أزرار التحكم */
        .btn {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            text-decoration: none;
            font-family: inherit;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: linear-gradient(45deg, var(--success-color), #66bb6a);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, var(--warning-color), #ffb74d);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, var(--danger-color), #e57373);
        }
        
        /* حقول الإدخال */
        .form-input, .form-select {
            padding: 12px 20px;
            border: 2px solid var(--glass-border);
            border-radius: 15px;
            font-size: 1rem;
            width: 100%;
            outline: none;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: inherit;
            backdrop-filter: blur(10px);
        }
        
        .form-input:focus, .form-select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }
        
        .form-input::placeholder {
            color: var(--text-secondary);
        }
        
        /* التخطيط المرن */
        .flex {
            display: flex;
        }
        
        .flex-center {
            align-items: center;
            justify-content: center;
        }
        
        .flex-between {
            justify-content: space-between;
        }
        
        .flex-wrap {
            flex-wrap: wrap;
        }
        
        .gap-4 {
            gap: 1rem;
        }
        
        .gap-6 {
            gap: 1.5rem;
        }
        
        /* الشبكة المرنة */
        .grid {
            display: grid;
        }
        
        .grid-auto {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }
        
        /* المسافات */
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        
        /* النصوص */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        
        /* الألوان */
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-success { color: var(--success-color); }
        .text-warning { color: var(--warning-color); }
        .text-danger { color: var(--danger-color); }
        .text-accent-blue { color: var(--accent-blue); }
        .text-accent-green { color: var(--accent-green); }
        .text-accent-orange { color: var(--accent-orange); }
        
        /* الرسوم المتحركة */
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8,0,1,1); }
            50% { transform: none; animation-timing-function: cubic-bezier(0,0,0.2,1); }
        }
        
        /* التحميل */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--accent-blue);
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 212, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* مؤشرات الحالة */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
        }
        
        .bg-success { background-color: var(--success-color); }
        .bg-warning { background-color: var(--warning-color); }
        .bg-danger { background-color: var(--danger-color); }
        
        /* بطاقات النتائج */
        .result-card {
            background: var(--card-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 30px;
            position: relative;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            cursor: pointer;
        }
        
        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .result-card:hover::before {
            left: 100%;
        }
        
        .result-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: var(--shadow-glow);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            position: relative;
            z-index: 2;
        }
        
        .mango-info {
            flex: 1;
        }
        
        .mango-variety {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .mango-scientific-name {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 10px;
        }
        
        .quality-badge {
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .quality-excellent {
            background: var(--success-gradient);
            color: white;
            animation: pulse-excellent 3s infinite;
        }
        
        .quality-good {
            background: var(--warning-gradient);
            color: white;
        }
        
        .quality-premium {
            background: var(--secondary-gradient);
            color: white;
            animation: pulse-premium 3s infinite;
        }
        
        @keyframes pulse-excellent {
            0%, 100% { box-shadow: 0 0 0 0 rgba(79, 172, 254, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(79, 172, 254, 0); }
        }
        
        @keyframes pulse-premium {
            0%, 100% { box-shadow: 0 0 0 0 rgba(240, 147, 251, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(240, 147, 251, 0); }
        }
        
        .card-content {
            position: relative;
            z-index: 2;
        }
        
        .location-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .location-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .location-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .location-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        
        .location-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .location-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1rem;
        }
        
        .area-highlight {
            color: var(--text-accent) !important;
            font-size: 1.2rem !important;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-accent);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .characteristics {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .characteristics-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        
        .characteristics-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .characteristic-tag {
            background: var(--primary-gradient);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        /* Loading و Empty States */
        .loading-container {
            text-align: center;
            padding: 60px 20px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--text-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--text-secondary);
        }
        
        /* مؤشرات الإحصائيات */
        .statistics-panel {
            background: var(--card-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
        }
        
        .statistics-title {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 25px;
            color: var(--text-primary);
        }
        
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .statistic-card {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            transition: all 0.3s ease;
        }
        
        .statistic-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
        }
        
        .statistic-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: var(--area-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .statistic-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-accent);
            margin-bottom: 8px;
        }
        
        .statistic-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* تحسينات الجوال */
        @media (max-width: 1200px) {
            .container { padding: 15px; }
            .grid-4 { grid-template-columns: repeat(3, 1fr); }
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
            .main-title { font-size: 2rem; }
            .subtitle { font-size: 1rem; }
            .flex { flex-direction: column; }
            .btn { padding: 10px 20px; font-size: 0.9rem; }
            
            .location-details {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .results-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .sort-options {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .main-title { font-size: 1.8rem; }
            .card { padding: 15px; }
            .btn { padding: 8px 16px; }
        }
        
        /* تأثيرات إضافية */
        .ripple-effect {
            position: relative;
            overflow: hidden;
        }
        
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
        }
        
        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* تخصيصات الخريطة */
        .leaflet-popup-content-wrapper {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            color: var(--text-primary);
            border-radius: 15px;
            border: 1px solid var(--glass-border);
        }
        
        .leaflet-popup-tip {
            background: var(--card-bg);
        }
        
        /* شريط التمرير المخصص */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--darker-bg);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
        
        /* مؤشرات التحديث */
        .update-status, .update-indicator, .loading {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 999;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .update-status .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: green;
            display: inline-block;
            margin-left: 5px;
        }
        
        .update-indicator {
            top: 10px;
            left: 10px;
            display: none;
        }
        
        .loading {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            text-align: center;
        }
        
        /* منطقة البحث المتقدم */
        .search-section {
            background: var(--card-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 40px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }
        
        .search-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg at 50% 50%, transparent, rgba(102, 126, 234, 0.1), transparent);
            animation: rotate 15s linear infinite;
            opacity: 0.7;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .search-content {
            position: relative;
            z-index: 2;
        }
        
        .search-title {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            background: var(--search-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .search-input-container {
            position: relative;
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-accent);
            font-size: 1.2rem;
            pointer-events: none;
        }
        
        .search-btn {
            background: var(--search-gradient);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .search-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .search-btn:hover::before {
            left: 100%;
        }
        
        .search-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
        }
        
        .advanced-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .filter-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .filter-group:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .range-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .range-input {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--text-accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 242, 254, 0.5);
        }
        
        .range-value {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            color: var(--text-accent);
        }
        
        /* منطقة النتائج */
        .results-section {
            margin: 40px 0;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .results-title {
            font-size: 2rem;
            font-weight: 700;
            background: var(--area-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .results-count {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 10px 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .sort-options {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .sort-btn {
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sort-btn.active,
        .sort-btn:hover {
            background: var(--success-gradient);
            color: white;
            transform: translateY(-2px);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }
    </style>




  <style>
    /* ✅ موبايل */
    @media (max-width: 768px) {
      .results-header {
        flex-direction: column;
        text-align: center;
      }
      .btn { font-size: 13px; padding: 8px 12px; }
    }
  </style>
  
</head>

<body>
    <!-- الحاوي الرئيسي -->
    <div class="container">
        <!-- قسم الهيدر الرئيسي -->
        <header class="header text-center mb-8">
            <h1 class="main-title mb-4">
                <i class="fas fa-seedling text-warning"></i>
                نظام تتبع المانجو الكيت المتقدم
            </h1>
            <p class="subtitle mb-4">
                <i class="fas fa-map-marked-alt text-accent-blue"></i>
               •  طريق مصر الإسكندرية الصحراوي • 
            </p>
        </header>
        
        <!-- لوحة المعلومات الرئيسية -->
        <section class="status-overview mb-8">
            <div class="card">
                <h2 class="text-2xl font-bold mb-6 text-center">
                    <i class="fas fa-chart-pie text-accent-green"></i>
                    لوحة المعلومات الرئيسية
                </h2>
                <div class="grid grid-auto gap-6">
                    <div class="stat-card text-center p-4">
                        <div class="stat-icon mb-4">
                            <i class="fas fa-map-marker-alt text-accent-blue text-3xl"></i>
                        </div>
                        <div class="stat-value text-3xl font-bold text-accent-green" id="totalRegions">847</div>
                        <div class="stat-label text-secondary">إجمالي المناطق المنتجة</div>
                    </div>
                    <div class="stat-card text-center p-4">
                        <div class="stat-icon mb-4">
                            <i class="fas fa-check-circle text-success text-3xl"></i>
                        </div>
                        <div class="stat-value text-3xl font-bold text-success" id="availableCount">568</div>
                        <div class="stat-label text-secondary">متوفر للحصاد</div>
                    </div>
                    <div class="stat-card text-center p-4">
                        <div class="stat-icon mb-4">
                            <i class="fas fa-tractor text-warning text-3xl"></i>
                        </div>
                        <div class="stat-value text-3xl font-bold text-warning" id="totalFarms">2,847</div>
                        <div class="stat-label text-secondary">عدد المزارع المسجلة</div>
                    </div>
                    <div class="stat-card text-center p-4">
                        <div class="stat-icon mb-4">
                            <i class="fas fa-weight-hanging text-accent-blue text-3xl"></i>
                        </div>
                        <div class="stat-value text-3xl font-bold text-accent-blue" id="totalQuantity">680,400</div>
                        <div class="stat-label text-secondary">الإنتاج المتوقع (طن)</div>
                    </div>
                    <div class="stat-card text-center p-4">
                        <div class="stat-icon mb-4">
                            <i class="fas fa-coins text-warning text-3xl"></i>
                        </div>
                        <div class="stat-value text-3xl font-bold text-warning" id="averagePrice">47.50</div>
                        <div class="stat-label text-secondary">متوسط السعر (جنيه/كيلو)</div>
                    </div>
                    <div class="stat-card text-center p-4">
                        <div class="stat-icon mb-4">
                            <i class="fas fa-clock text-accent-green text-3xl"></i>
                        </div>
                        <div class="stat-value text-3xl font-bold text-accent-green" id="lastUpdate">الآن</div>
                        <div class="stat-label text-secondary">آخر تحديث</div>
                    </div>
                </div>
            </div>
        </section>

<!-- 📊 توقع سعر مانجو كيت (مناطق طريق الإسكندرية الصحراوي) -->
<section class="price-forecast-regional mb-12">
  <div class="card glass-card p-8 text-center rounded-2xl shadow-2xl border border-white/20">
    
    <h3 class="text-3xl font-extrabold mb-8 flex items-center justify-center gap-3 text-white drop-shadow">
      <i class="fas fa-globe text-accent-green text-3xl"></i>
      متوسط سعر مانجو كيت المتوقع للأسبوع القادم – طريق إسكندرية الصحراوي
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <!-- متوسط السعر -->
      <div class="glass-box p-6 rounded-2xl shadow-inner border border-white/10">
        <p class="text-lg font-semibold mb-3 flex items-center justify-center gap-2 text-white">
          <i class="fas fa-hourglass-half text-accent-blue text-xl"></i>
          متوسط السعر الأسبوعي
        </p>
        <span id="avgWeeklyRegionalPrice" class="text-3xl font-extrabold text-accent-blue drop-shadow">--</span> <span class="text-white">ج</span>
      </div>

      <!-- السعر القادم -->
      <div class="glass-box p-6 rounded-2xl shadow-inner border border-white/10">
        <p class="text-lg font-semibold mb-3 flex items-center justify-center gap-2 text-white">
          <i class="fas fa-chart-line text-success text-xl"></i>
          السعر للأسبوع القادم
        </p>
        <span id="expectedRegionalPrice" class="text-3xl font-extrabold text-success drop-shadow">--</span> <span class="text-white">ج</span>
      </div>

      <!-- الملاحظة -->
      <div class="glass-box p-6 rounded-2xl shadow-inner border border-white/10">
        <p class="text-lg font-semibold mb-3 flex items-center justify-center gap-2 text-white">
          <i class="fas fa-lightbulb text-warning text-xl"></i>
          ملاحظة
        </p>
        <p id="regionalPriceInsight" class="text-sm text-gray-200 leading-relaxed">
          يتم الآن تحليل الأسعار من المواقع الإلكترونية والتواصل الاجتماعي...
        </p>
      </div>
    </div>
  </div>
</section>

<!-- 🔮 توقعات سعر المانجو كيت -->
<section class="forecast-section mb-12">
  <div class="card glass-card p-8 text-center rounded-2xl shadow-2xl border border-white/20">
    
    <h2 class="text-3xl font-extrabold mb-8 flex items-center justify-center gap-3 text-white drop-shadow">
      <i class="fas fa-brain text-accent-green text-3xl"></i>
      توقعات سعر مانجو كيت (أسبوع / شهر / 3 شهور)
    </h2>

    <!-- أزرار الفترات -->
    <div class="flex flex-wrap justify-center gap-4 mb-8">
      <button class="btn btn-primary px-6 py-3 rounded-xl font-semibold shadow-md hover:scale-105 transition" onclick="showForecast('week')">
        <i class="fas fa-calendar-week"></i> أسبوع
      </button>
      <button class="btn btn-success px-6 py-3 rounded-xl font-semibold shadow-md hover:scale-105 transition" onclick="showForecast('month')">
        <i class="fas fa-calendar-alt"></i> شهر
      </button>

      <button class="btn btn-success px-6 py-3 rounded-xl font-semibold shadow-md hover:scale-105 transition" onclick="showForecast('month')">
      <i class="fas fa-calendar-alt"></i> 3 شهور
      </button>
    </div>

    <!-- نتيجة التوقع -->
    <div id="forecastResult" class="forecast-box p-8 rounded-2xl bg-glass shadow-inner border border-white/10">
      <p class="text-2xl font-bold mb-4 flex items-center justify-center gap-3 text-white">
        <i class="fas fa-magic text-accent-blue text-2xl"></i>
        السعر المتوقع:
        <span id="forecastPrice" class="text-accent-blue font-extrabold drop-shadow">--</span> <span class="text-white">جنيه/كجم</span>
      </p>
      <p class="text-lg text-gray-200 flex items-center justify-center gap-2 mb-2">
        <i class="fas fa-bullseye text-success text-xl"></i>
        دقة التوقع:
        <span id="forecastConfidence" class="text-success font-bold">--%</span>
      </p>
      <p class="text-sm mt-2 text-gray-300 italic" id="forecastNote">
        يرجى اختيار فترة للتوقع
      </p>
    </div>
  </div>
</section>


        <!-- الخريطة التفاعلية -->
        <section class="interactive-map mb-8">
            <div class="card">
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-map text-accent-blue"></i>
                    خريطة تفاعلية لمناطق إنتاج المانجو
                </h2>
    
                <div class="glass-panel">
                    <div class="controls">
                        <div class="control-group">
                            <label for="mapType">نوع الخريطة:</label>
                            <select id="mapType" title="نوع الخريطة">
                                <option value="satellite">صور الأقمار الصناعية</option>
                                <option value="hybrid">مختلط (قمر صناعي + طرق)</option>
                                <option value="terrain">التضاريس</option>
                                <option value="osm">خريطة الشوارع</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>عرض:</label>
                            <select id="displayOptions">
                                <option value="mango_farms">مزارع المانجو</option>
                                <option value="agriculture">جميع الأراضي الزراعية</option>
                                <option value="irrigation">شبكات الري</option>
                                <option value="markets">الأسواق والتجارة</option>
                                <option value="all">عرض الكل</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>تاريخ الصورة:</label>
                            <input type="date" id="imageDate" value="2024-12-01">
                        </div>
                        
                        <div class="control-group" style="align-self: end;">
                            <button class="btn btn-primary" onclick="updateMap()">
                                <i class="fas fa-sync-alt"></i>
                                تحديث الخريطة
                            </button>
                        </div>
                        
                        <div class="control-group" style="align-self: end;">
                            <button class="btn btn-secondary" onclick="analyzeMangoRegion()">
                                <i class="fas fa-chart-line"></i>
                                تحليل إنتاج المانجو
                            </button>
                        </div>
                    </div>
                </div>

                <div class="map-container">
                    <div class="info-panel">
                        <div class="info-title">معلومات خريطة المانجو</div>
                        <div class="info-text">
                            <strong>المصدر:</strong> Sentinel-2, Landsat-9<br>
                            <strong>الدقة:</strong> 10-30 متر للبكسل<br>
                            <strong>التحديث:</strong> أسبوعي<br>
                            <strong>التخصص:</strong> تحليل محاصيل المانجو<br>
                            <strong>الموسم:</strong> يونيو - سبتمبر
                        </div>
                    </div>
                    <div id="map"></div>
                </div>

                <div class="legend">
                    <div class="legend-title">مفتاح خريطة المانجو</div>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fb923c;"></div>
                            <span>مزارع المانجو المثمرة</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fcd34d;"></div>
                            <span>مزارع المانجو الصغيرة</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4ade80;"></div>
                            <span>أراضي زراعية أخرى</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #06b6d4;"></div>
                            <span>شبكات الري والمياه</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #8b5cf6;"></div>
                            <span>مراكز التجميع والتسويق</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ef4444;"></div>
                            <span>مناطق حضرية وطرق</span>
                        </div>
                    </div>
                </div>

                <!-- تحليل متقدم -->
                <div class="analysis-panel">
                    <div class="analysis-title">
                        <i class="fas fa-chart-pie"></i>
                        تحليل إنتاج المانجو 2024
                    </div>
                    <div class="analysis-grid">
                        <div class="analysis-item">
                            <div class="analysis-metric" id="totalProduction">15,420</div>
                            <div class="analysis-label">طن إجمالي الإنتاج</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-metric" id="farmArea">2,847</div>
                            <div class="analysis-label">فدان مساحة المانجو</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-metric" id="avgYield">5.4</div>
                            <div class="analysis-label">طن/فدان متوسط الإنتاجية</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-metric" id="farmsCount">184</div>
                            <div class="analysis-label">مزرعة مانجو نشطة</div>
                        </div>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalMangoFarms">184</div>
                        <div class="stat-label">مزرعة مانجو</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analysisAccuracy">94%</div>
                        <div class="stat-label">دقة التحليل</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeRegions">6</div>
                        <div class="stat-label">منطقة إنتاج رئيسية</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="marketCenters">12</div>
                        <div class="stat-label">مركز تسويق</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- بطاقات المناطق المتقدمة -->
        <section class="regions-section mb-8">
            <h2 class="text-2xl font-bold mb-6 text-center">
                <i class="fas fa-map-marked-alt text-accent-green"></i>
                تفاصيل مناطق إنتاج المانجو
            </h2>
            <div class="grid grid-auto gap-6" id="regionsGrid">
                <!-- سيتم ملء البيانات ديناميكياً بـ JavaScript -->
            </div>
        </section>
    </div>

    <div class="loading" id="loadingPanel">
        <div class="spinner"></div>
        <div class="loading-text">جارٍ تحليل بيانات مزارع المانجو...</div>
    </div>


        <!-- محرك البحث المتقدم -->
        <section class="advanced-search mb-8">
            <div class="card">
                <h2 class="text-2xl font-bold mb-6 text-center">
                    <i class="fas fa-search text-accent-green"></i>
                    البحث المتقدم عن أصناف المانجو
                </h2>
                
                <form id="searchForm" class="grid grid-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">نوع المانجو</label>
                        <input type="text" id="mangoVariety" class="form-input" placeholder="كيت، عويس، زبدية...">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">المنطقة</label>
                        <select id="region" class="form-select">
                            <option value="">جميع المناطق</option>
                            <option value="الإسماعيلية">الإسماعيلية</option>
                            <option value="الشرقية">الشرقية</option>
                            <option value="البحيرة">البحيرة</option>
                            <option value="الجيزة">الجيزة</option>
                            <option value="المنوفية">المنوفية</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">الجودة</label>
                        <select id="quality" class="form-select">
                            <option value="">جميع المستويات</option>
                            <option value="ممتاز">ممتاز</option>
                            <option value="جيد جداً">جيد جداً</option>
                            <option value="جيد">جيد</option>
                            <option value="تصدير">تصدير</option>
                        </select>
                    </div>
                </form>
                
                <div class="advanced-filters">
                    <div class="filter-group">
                        <label class="form-label">المساحة (فدان)</label>
                        <div class="range-container">
                            <input type="range" id="areaMin" class="range-input" min="0" max="1000" value="0">
                            <span class="range-value" id="areaMinValue">0</span>
                        </div>
                        <div class="range-container">
                            <input type="range" id="areaMax" class="range-input" min="0" max="1000" value="1000">
                            <span class="range-value" id="areaMaxValue">1000</span>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label class="form-label">الإنتاجية (طن/فدان)</label>
                        <div class="range-container">
                            <input type="range" id="productivityMin" class="range-input" min="0" max="30" value="0" step="0.5">
                            <span class="range-value" id="productivityMinValue">0</span>
                        </div>
                        <div class="range-container">
                            <input type="range" id="productivityMax" class="range-input" min="0" max="30" value="30" step="0.5">
                            <span class="range-value" id="productivityMaxValue">30</span>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label class="form-label">الموسم</label>
                        <select id="season" class="form-select">
                            <option value="">جميع المواسم</option>
                            <option value="مبكر">مبكر</option>
                            <option value="منتصف الموسم">منتصف الموسم</option>
                            <option value="متأخر">متأخر</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="form-label">طريقة الري</label>
                        <select id="irrigation" class="form-select">
                            <option value="">جميع الطرق</option>
                            <option value="تنقيط">تنقيط</option>
                            <option value="رش">رش</option>
                            <option value="غمر">غمر</option>
                            <option value="محوري">محوري</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex flex-center gap-4 mb-6">
                    <button type="submit" form="searchForm" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        بحث متقدم
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetSearch()">
                        <i class="fas fa-undo"></i>
                        إعادة تعيين
                    </button>
                </div>
                
                <!-- نتائج البحث -->
                <div id="searchResults" class="mt-6">
                    <div class="text-center mb-4">
                        <span class="text-lg font-semibold" id="resultsCount">جاري تحميل البيانات...</span>
                    </div>
                    <div class="grid grid-auto gap-4" id="resultsGrid">
                        <!-- سيتم ملء نتائج البحث هنا -->
                    </div>
                </div>
            </div>
        </section>

<!-- مصادر البيانات المباشرة -->
<section class="data-sources mb-12">
  <div class="card bg-glass p-8 rounded-2xl shadow-lg">
    <h2 class="text-2xl font-bold mb-10 text-center text-white">
      <i class="fas fa-database text-accent-blue mr-2"></i>
      مصادر البيانات المباشرة والموثقة
    </h2>

    <!-- الشبكة -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">

      <!-- الأقمار الصناعية -->
      <div class="bg-glass rounded-2xl p-6 text-center shadow-md hover:shadow-xl transition">
        <div class="flex justify-center mb-4">
          <div class="p-5 rounded-full shadow-md" style="background: linear-gradient(135deg,#4facfe,#00f2fe);">
            <i class="fas fa-satellite text-white text-2xl"></i>
          </div>
        </div>
        <h3 class="text-lg font-semibold text-white mb-2">الأقمار الصناعية</h3>
        <div class="flex items-center justify-center gap-2 mb-3">
          <span class="status-dot bg-success animate-pulse"></span>
          <span class="text-success text-sm">متصل ونشط</span>
        </div>
        <div class="text-3xl font-bold text-accent-green mb-2" id="satelliteData">2,847</div>
        <p class="text-secondary">مزرعة مراقبة عبر الأقمار الصناعية</p>
        <div class="text-sm text-accent-blue mt-2">دقة 98.7%</div>
      </div>

      <!-- السوشيال ميديا -->
      <div class="bg-glass rounded-2xl p-6 text-center shadow-md hover:shadow-xl transition">
        <div class="flex justify-center mb-4">
          <div class="p-5 rounded-full shadow-md" style="background: linear-gradient(135deg,#ff6a00,#ee0979);">
            <i class="fab fa-facebook text-white text-2xl"></i>
          </div>
        </div>
        <h3 class="text-lg font-semibold text-white mb-2">وسائل التواصل الاجتماعي</h3>
        <div class="flex items-center justify-center gap-2 mb-3">
          <span class="status-dot bg-success animate-pulse"></span>
          <span class="text-success text-sm">متصل ونشط</span>
        </div>
        <div class="text-3xl font-bold text-accent-green mb-2" id="socialData">12.4K</div>
        <p class="text-secondary">تقارير من المزارعين والتجار</p>
        <div class="text-sm text-accent-blue mt-2">تحديث مباشر</div>
      </div>

      <!-- الأرصاد -->
      <div class="bg-glass rounded-2xl p-6 text-center shadow-md hover:shadow-xl transition">
        <div class="flex justify-center mb-4">
          <div class="p-5 rounded-full shadow-md" style="background: linear-gradient(135deg,#56ccf2,#2f80ed);">
            <i class="fas fa-cloud-sun text-white text-2xl"></i>
          </div>
        </div>
        <h3 class="text-lg font-semibold text-white mb-2">محطات الأرصاد</h3>
        <div class="flex items-center justify-center gap-2 mb-3">
          <span class="status-dot bg-success animate-pulse"></span>
          <span class="text-success text-sm">متصل ونشط</span>
        </div>
        <div class="text-3xl font-bold text-accent-green mb-2" id="weatherData">32°</div>
        <p class="text-secondary">درجة الحرارة والرطوبة المثلى</p>
        <div class="text-sm text-accent-blue mt-2">65% رطوبة</div>
      </div>

      <!-- الأسواق -->
      <div class="bg-glass rounded-2xl p-6 text-center shadow-md hover:shadow-xl transition">
        <div class="flex justify-center mb-4">
          <div class="p-5 rounded-full shadow-md" style="background: linear-gradient(135deg,#11998e,#38ef7d);">
            <i class="fas fa-chart-line text-white text-2xl"></i>
          </div>
        </div>
        <h3 class="text-lg font-semibold text-white mb-2">بيانات الأسواق</h3>
        <div class="flex items-center justify-center gap-2 mb-3">
          <span class="status-dot bg-success animate-pulse"></span>
          <span class="text-success text-sm">متصل ونشط</span>
        </div>
        <div class="text-3xl font-bold text-accent-green mb-2" id="marketData">47</div>
        <p class="text-secondary">سوق مركزي وتاجر جملة</p>
        <div class="text-sm text-accent-blue mt-2">API مباشر</div>
      </div>

    </div>
  </div>
</section>




        
  <style>
        :root {
            --primary: #1e40af;
            --secondary: #059669;
            --accent-blue: #0ea5e9;
            --accent-green: #10b981;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --mango-color: #fb923c;
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.8rem;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.3rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 20px;
        }

        .badge {
            display: inline-block;
            padding: 8px 16px;
            background: var(--mango-color);
            color: white;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0 5px;
        }

        .glass-panel, .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .interactive-map {
            margin-bottom: 30px;
        }

        .map-controls {
            margin-bottom: 20px;
        }

        .flex {
            display: flex;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .flex-center {
            justify-content: center;
            align-items: center;
        }

        .gap-4 {
            gap: 1rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mb-8 {
            margin-bottom: 2rem;
        }

        .text-2xl {
            font-size: 1.5rem;
        }

        .font-bold {
            font-weight: bold;
        }

        .text-center {
            text-align: center;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1e3a8a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #047857;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .form-input {
            padding: 12px;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            transition: all 0.3s ease;
            max-width: 300px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        select, input[type="date"] {
            padding: 12px;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        select:focus, input[type="date"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .map-container {
            position: relative;
            margin-bottom: 30px;
        }

        #map {
            height: 700px;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--glass-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            max-width: 300px;
        }

        .info-title {
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .info-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .legend {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            margin-bottom: 30px;
        }

        .legend-title {
            color: white;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .grid {
            display: grid;
        }

        .grid-auto {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .region-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .region-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .region-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .region-title {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .region-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-excellent {
            background: var(--success);
            color: white;
        }

        .status-good {
            background: var(--accent-blue);
            color: white;
        }

        .status-average {
            background: var(--warning);
            color: white;
        }

        .region-details {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .detail-label {
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--mango-color) 100%);
            transition: width 0.5s ease;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            z-index: 2000;
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-weight: 600;
            text-align: center;
        }

        .custom-popup {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 300px;
        }

        .popup-title {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .popup-content {
            color: var(--text-primary);
            line-height: 1.5;
        }

        .popup-detail {
            margin: 5px 0;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .popup-highlight {
            color: var(--mango-color);
            font-weight: bold;
        }

        .analysis-panel {
            background: linear-gradient(135deg, var(--glass-bg), rgba(251, 146, 60, 0.1));
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .analysis-title {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .analysis-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .analysis-metric {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--mango-color);
            margin-bottom: 5px;
        }

        .analysis-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            #map {
                height: 500px;
            }
            
            .info-panel {
                position: static;
                margin-bottom: 20px;
            }
            
            .flex {
                flex-direction: column;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>



<!-- لوحة التحكم -->
        <section class="control-panel mb-8">
            <div class="card text-center">
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-cog text-accent-blue"></i>
                    لوحة التحكم المتقدمة
                </h2>
                <div class="flex flex-wrap gap-4 flex-center">
                    <button class="btn btn-primary" onclick="updateAllData()">
                        <i class="fas fa-sync-alt"></i> تحديث شامل
                    </button>
                    <button class="btn btn-success" onclick="exportData()">
                        <i class="fas fa-download"></i> تصدير البيانات
                    </button>
                    <button class="btn btn-warning" onclick="showAnalytics()">
                        <i class="fas fa-chart-line"></i> تحليل متقدم
                    </button>
                    <button class="btn btn-info" onclick="generateReport()">
                        <i class="fas fa-file-alt"></i> تقرير شامل
                    </button>
                    <button class="btn btn-secondary" onclick="showSettings()">
                        <i class="fas fa-cogs"></i> الإعدادات
                    </button>
                </div>
            </div>
        </section>
    </div>
    
    <!-- مؤشرات التحديث -->
    <div class="update-status" id="updateStatus">
        <div class="status-dot animate-pulse"></div>
        <span id="updateText">متصل مباشر</span>
    </div>
    
    <!-- مؤشر التحديث العلوي -->
    <div class="update-indicator" id="updateIndicator">
        <i class="fas fa-sync-alt animate-spin"></i>
        <span>جاري التحديث...</span>
    </div>
    
    <!-- حالة التحميل العامة -->
    <div class="loading" id="globalLoading">
        <div class="spinner"></div>
        <p class="mt-4">جاري تحميل البيانات...</p>
    </div>









    <!-------------------- JavaScript ----------------------------------->
    
    
    
    <script>


// ======== وحدة إدارة التطبيق الرئيسية ========
class MangoTrackingApp {
    constructor() {
        // إعدادات التطبيق
        this.config = {
            apiEndpoints: {
                prices: 'https://api.example.com/prices',
                regions: 'https://api.example.com/regions',
                forecasts: 'https://api.example.com/forecasts'
            },
            updateInterval: 30000, // 30 ثانية
            cacheExpiry: 600000, // 10 دقائق
            mapCenter: [30.0444, 31.2357],
            mapZoom: 6
        };
        
        // حالة التطبيق
        this.state = {
            data: {
                mangoDatabase: [],
                filteredResults: [],
                regions: [],
                prices: {},
                forecasts: {}
            },
            ui: {
                currentSort: 'area',
                loading: false,
                lastUpdate: null
            },
            map: null,
            charts: {}
        };
        
        // تهيئة التطبيق
        this.init();
    }
    
    // ======== التهيئة الأولية ========
    async init() {
        try {
            console.log('🥭 بدء تشغيل نظام تتبع المانجو الكيت...');
            
            // تحقق من توفر المتصفحات الحديثة
            this.checkBrowserCompatibility();
            
            // إعداد معالجات الأحداث
            this.setupEventListeners();
            
            // تحميل البيانات المخزنة محلياً
            await this.loadCachedData();
            
            // تحميل البيانات من الخادم
            await this.fetchInitialData();
            
            // تهيئة المكونات
            this.initializeComponents();
            
            // بدء التحديثات التلقائية
            this.startAutoUpdates();
            
            console.log('✅ تم تهيئة النظام بنجاح');
        } catch (error) {
            console.error('❌ خطأ في تهيئة النظام:', error);
            this.showError('فشل تحميل التطبيق، يرجى تحديث الصفحة');
        }
    }
    
    // ======== التحقق من توافق المتصفح ========
    checkBrowserCompatibility() {
        const requiredFeatures = [
            'fetch',
            'Promise',
            'localStorage',
            'IntersectionObserver',
            'ServiceWorker'
        ];
        
        const missingFeatures = requiredFeatures.filter(feature => !(feature in window));
        
        if (missingFeatures.length > 0) {
            console.warn('⚠️ المتصفح يفتقد إلى بعض الميزات:', missingFeatures);
            // يمكن هنا إضافة رسالة للمستخدم أو توفير بديل
        }
    }
    
    // ======== إعداد معالجات الأحداث ========
    setupEventListeners() {
        // منع إعادة إرسال النماذج
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', (e) => e.preventDefault());
        });
        
        // أحداث البحث
        const searchInput = document.getElementById('mangoVariety');
        if (searchInput) {
            // استخدام debounce لتحسين الأداء
            searchInput.addEventListener('input', this.debounce(() => {
                this.performSearch();
            }, 500));
        }
        
        // أحداث الفلاتر
        ['region', 'quality', 'season', 'irrigation'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', () => this.performSearch());
            }
        });
        
        // أحداث الـ sliders
        ['areaMin', 'areaMax', 'productivityMin', 'productivityMax'].forEach(id => {
            const slider = document.getElementById(id);
            if (slider) {
                slider.addEventListener('input', () => {
                    this.updateSliderValues();
                    // استخدام throttle للتحكم في تكرار التحديث
                    this.throttle(() => this.performSearch(), 300)();
                });
            }
        });
        
        // أحداث الفرز
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.state.ui.currentSort = btn.dataset.sort;
                this.displayResults(this.state.data.filteredResults);
            });
        });
        
        // أحداث لوحة التحكم
        this.setupControlPanelEvents();
        
        // حفظ حالة التطبيق قبل إغلاق الصفحة
        window.addEventListener('beforeunload', () => this.saveAppState());
    }
    
    // ======== تحميل البيانات المخزنة محلياً ========
    async loadCachedData() {
        try {
            // محاولة تحميل البيانات من localStorage
            const cachedData = localStorage.getItem('mangoTrackingData');
            
            if (cachedData) {
                const parsedData = JSON.parse(cachedData);
                
                // التحقق من صلاحية البيانات المخزنة
                if (this.isDataValid(parsedData)) {
                    console.log('📦 تحميل البيانات من التخزين المحلي');
                    this.state.data = { ...this.state.data, ...parsedData };
                    this.displayResults(this.state.data.filteredResults);
                    return;
                }
            }
            
            console.log('🔄 لا توجد بيانات صالحة في التخزين المحلي');
        } catch (error) {
            console.error('خطأ في تحميل البيانات المخزنة:', error);
        }
    }
    
    // ======== التحقق من صلاحية البيانات ========
    isDataValid(data) {
        if (!data || !data.lastUpdate) return false;
        
        // التحقق من انتهاء صلاحية البيانات
        const now = new Date().getTime();
        const dataAge = now - new Date(data.lastUpdate).getTime();
        
        return dataAge < this.config.cacheExpiry;
    }
    
    // ======== جلب البيانات الأولية ========
    async fetchInitialData() {
        this.showLoader(true);
        
        try {
            // استخدام Promise.all لجلب البيانات بشكل متوازٍ
            const [mangoData, regionsData, pricesData, forecastsData] = await Promise.all([
                this.fetchMangoData(),
                this.fetchRegionsData(),
                this.fetchPricesData(),
                this.fetchForecastsData()
            ]);
            
            // تحديث حالة التطبيق
            this.state.data.mangoDatabase = mangoData;
            this.state.data.filteredResults = [...mangoData];
            this.state.data.regions = regionsData;
            this.state.data.prices = pricesData;
            this.state.data.forecasts = forecastsData;
            this.state.ui.lastUpdate = new Date();
            
            // حفظ البيانات محلياً
            this.saveDataLocally();
            
            // تحديث الواجهة
            this.updateDashboard();
            this.displayResults(this.state.data.filteredResults);
            
            console.log('✅ تم تحميل البيانات بنجاح');
        } catch (error) {
            console.error('❌ خطأ في جلب البيانات:', error);
            this.showError('فشل تحميل البيانات، يرجى التحقق من اتصال الإنترنت');
        } finally {
            this.showLoader(false);
        }
    }
    
    // ======== جلب بيانات المانجو ========
    async fetchMangoData() {
        // محاكاة جلب البيانات من API
        // في التطبيق الحقيقي، سيتم استبدال هذا بـ fetch حقيقي
        return new Promise((resolve) => {
            setTimeout(() => {
                resolve(this.getMangoDatabase());
            }, 1000);
        });
    }
    
    // ======== جلب بيانات المناطق ========
    async fetchRegionsData() {
        // محاكاة جلب البيانات من API
        return new Promise((resolve) => {
            setTimeout(() => {
                resolve([
                    { name: "الإسماعيلية", farms: 340, quantity: 980, price: 45 },
                    { name: "البحيرة", farms: 220, quantity: 720, price: 44 },
                    { name: "الجيزة", farms: 180, quantity: 600, price: 49 },
                    { name: "المنوفية", farms: 150, quantity: 520, price: 46 },
                    { name: "الشرقية", farms: 290, quantity: 850, price: 47 }
                ]);
            }, 800);
        });
    }
    
    // ======== جلب بيانات الأسعار ========
    async fetchPricesData() {
        // محاكاة جلب البيانات من API
        return new Promise((resolve) => {
            setTimeout(() => {
                resolve({
                    current: 65,
                    historical: [62, 63, 64, 65, 65, 65],
                    regions: {
                        "الإسماعيلية": 45,
                        "الشرقية": 47,
                        "البحيرة": 44,
                        "الجيزة": 49,
                        "المنوفية": 46
                    },
                    lastUpdate: new Date().toISOString()
                });
            }, 1200);
        });
    }
    
    // ======== جلب بيانات التوقعات ========
    async fetchForecastsData() {
        // محاكاة جلب البيانات من API
        return new Promise((resolve) => {
            setTimeout(() => {
                resolve({
                    week: {
                        labels: ['اليوم', 'غدًا', '2 أيام', '3 أيام', '4 أيام', '5 أيام', '6 أيام'],
                        values: [65, 65.5, 66, 66.5, 67, 67.5, 68],
                        price: 68,
                        confidence: 92
                    },
                    month: {
                        labels: ['مارس', 'أبريل'],
                        values: [65, 69],
                        price: 69,
                        confidence: 88
                    },
                    quarter: {
                        labels: ['مارس', 'أبريل', 'مايو'],
                        values: [65, 69, 72],
                        price: 72,
                        confidence: 85
                    }
                });
            }, 1500);
        });
    }
    
    // ======== تهيئة المكونات ========
    initializeComponents() {
        // تهيئة الخريطة
        this.initializeMap();
        
        // تهيئة الرسوم البيانية
        this.initializeCharts();
        
        // تهيئة تأثيرات الواجهة
        this.initializeUIEffects();
        
        // إعداد IntersectionObserver للتحميل الكسول
        this.setupLazyLoading();
    }
    
    // ======== تهيئة الخريطة ========
    initializeMap() {
        // التحقق من وجود عنصر الخريطة
        const mapContainer = document.getElementById('map');
        if (!mapContainer) return;
        
        // إنشاء الخريطة
        this.state.map = L.map('map').setView(
            this.config.mapCenter, 
            this.config.mapZoom
        );
        
        // إضافة طبقة الخريطة
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(this.state.map);
        
        // إعداد أيقونات مخصصة
        this.setupMapIcons();
        
        console.log('🗺️ تم تهيئة الخريطة بنجاح');
    }
    
    // ======== إعداد أيقونات الخريطة ========
    setupMapIcons() {
        // أيقونة المزارع
        this.farmIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/766/766570.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -30]
        });
        
        // أيقونة الأسواق
        this.marketIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -30]
        });
    }
    



    // ======== تهيئة الرسوم البيانية ========
    initializeCharts() {
        // التحقق من وجود عناصر الرسوم البيانية
        const chartElements = [
            'priceChart', 
            'quantityChart', 
            'productivityChart', 
            'trendChart',
            'forecastChart'
        ];
        
        chartElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                this.createChart(id);
            }
        });
        
        console.log('📊 تم تهيئة الرسوم البيانية بنجاح');
    }
    
    // ======== إنشاء رسم بياني ========
    createChart(id) {
        const ctx = document.getElementById(id).getContext('2d');
        
        // إعدادات عامة للرسوم البيانية
        const defaultOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: '#e2e8f0',
                        font: {
                            family: 'Cairo, sans-serif'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: {
                        family: 'Cairo, sans-serif',
                        size: 14
                    },
                    bodyFont: {
                        family: 'Cairo, sans-serif',
                        size: 13
                    },
                    padding: 12,
                    cornerRadius: 8
                }
            },
            scales: {
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: {
                            family: 'Cairo, sans-serif'
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: {
                            family: 'Cairo, sans-serif'
                        }
                    }
                }
            }
        };
        
        // إنشاء الرسم البياني المناسب بناءً على المعرف
        switch(id) {
            case 'priceChart':
                this.state.charts.priceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(this.state.data.prices.regions || {}),
                        datasets: [{
                            label: 'السعر بالجنيه',
                            data: Object.values(this.state.data.prices.regions || {}),
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(118, 75, 162, 0.8)',
                                'rgba(240, 147, 251, 0.8)',
                                'rgba(244, 114, 182, 0.8)',
                                'rgba(251, 146, 60, 0.8)'
                            ],
                            borderColor: [
                                'rgba(102, 126, 234, 1)',
                                'rgba(118, 75, 162, 1)',
                                'rgba(240, 147, 251, 1)',
                                'rgba(244, 114, 182, 1)',
                                'rgba(251, 146, 60, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: defaultOptions
                });
                break;
                
            case 'quantityChart':
                this.state.charts.quantityChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(this.state.data.prices.regions || {}),
                        datasets: [{
                            data: Object.values(this.state.data.regions.map(r => r.quantity) || []),
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(118, 75, 162, 0.8)',
                                'rgba(240, 147, 251, 0.8)',
                                'rgba(244, 114, 182, 0.8)',
                                'rgba(251, 146, 60, 0.8)'
                            ],
                            borderColor: [
                                'rgba(102, 126, 234, 1)',
                                'rgba(118, 75, 162, 1)',
                                'rgba(240, 147, 251, 1)',
                                'rgba(244, 114, 182, 1)',
                                'rgba(251, 146, 60, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        ...defaultOptions,
                        cutout: '60%'
                    }
                });
                break;
                
            case 'productivityChart':
                this.state.charts.productivityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                        datasets: [{
                            label: 'الإنتاجية',
                            data: [12, 15.2, 14, 16.5, 17],
                            borderColor: 'rgba(79, 172, 254, 1)',
                            backgroundColor: 'rgba(79, 172, 254, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(79, 172, 254, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: defaultOptions
                });
                break;
                
            case 'trendChart':
                this.state.charts.trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                        datasets: [{
                            label: 'السعر',
                            data: [40, 42, 43, 45, 47, 48],
                            borderColor: 'rgba(239, 68, 68, 1)',
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(239, 68, 68, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: defaultOptions
                });
                break;
                
            case 'forecastChart':
                // سيتم إنشاؤه عند تحديد فترة التوقع
                break;
        }
    }
    
    // ======== تهيئة تأثيرات الواجهة ========
    initializeUIEffects() {
        // تأثير الموجة عند النقر
        document.querySelectorAll('.ripple-effect').forEach(element => {
            element.addEventListener('click', (e) => this.createRipple(e, element));
        });
        
        // تأثيرات التمرير
        this.setupScrollEffects();
        
        // تأثيرات الحركة
        this.setupAnimationEffects();
    }
    
    // ======== إعداد IntersectionObserver للتحميل الكسول ========
    setupLazyLoading() {
        if ('IntersectionObserver' in window) {
            const lazyElements = document.querySelectorAll('.lazy-load');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const element = entry.target;
                        element.classList.add('loaded');
                        
                        // تحميل المحتوى إذا لزم الأمر
                        if (element.dataset.src) {
                            element.src = element.dataset.src;
                        }
                        
                        observer.unobserve(element);
                    }
                });
            }, {
                rootMargin: '50px'
            });
            
            lazyElements.forEach(element => {
                observer.observe(element);
            });
        }
    }
    
    // ======== بدء التحديثات التلقائية ========
    startAutoUpdates() {
        // تحديث البيانات بشكل دوري
        setInterval(() => {
            this.updateData();
        }, this.config.updateInterval);
        
        // تحديث الساعة
        this.updateClock();
        setInterval(() => this.updateClock(), 1000);
        
        console.log('🔄 بدء التحديثات التلقائية');
    }
    
    // ======== تحديث البيانات ========
    async updateData() {
        try {
            // تحديث الأسعار
            const newPrices = await this.fetchPricesData();
            this.state.data.prices = newPrices;
            
            // تحديث التوقعات
            const newForecasts = await this.fetchForecastsData();
            this.state.data.forecasts = newForecasts;
            
            // تحديث الواجهة
            this.updateDashboard();
            this.updateCharts();
            
            // تحديث وقت التحديث
            this.state.ui.lastUpdate = new Date();
            document.getElementById('lastUpdate').textContent = 'الآن';
            
            // حفظ البيانات محلياً
            this.saveDataLocally();
            
            console.log('🔄 تم تحديث البيانات');
        } catch (error) {
            console.error('❌ خطأ في تحديث البيانات:', error);
        }
    }
    
    // ======== تحديث لوحة المعلومات ========
    updateDashboard() {
        // تحديث الإحصائيات
        const stats = this.calculateStatistics();
        
        // تحديث العناصر في الواجهة
        this.updateElement('totalRegions', stats.totalRegions);
        this.updateElement('availableCount', stats.availableCount);
        this.updateElement('totalFarms', stats.totalFarms);
        this.updateElement('totalQuantity', stats.totalQuantity.toLocaleString('ar-EG'));
        this.updateElement('averagePrice', `${stats.averagePrice} ج/ك`);
        
        // تحديث مصادر البيانات
        this.updateDataSources();
        
        // تحديث توقعات الأسعار الإقليمية
        this.updateRegionalForecast();
    }
    
    // ======== حساب الإحصائيات ========
    calculateStatistics() {
        const data = this.state.data.mangoDatabase;
        
        return {
            totalRegions: new Set(data.map(item => item.region)).size,
            availableCount: data.filter(item => item.quality === 'ممتاز' || item.quality === 'جيد جداً').length,
            totalFarms: data.length,
            totalQuantity: data.reduce((sum, item) => sum + (item.area * item.productivity), 0),
            averagePrice: this.state.data.prices.current || 0
        };
    }
    
    // ======== تحديث عنصر في الواجهة ========
    updateElement(id, value) {
        const element = document.getElementById(id);
        if (element) {
            // إضافة تأثير حركي
            element.style.transform = 'scale(1.1)';
            element.style.transition = 'transform 0.3s ease';
            
            setTimeout(() => {
                element.textContent = value;
                element.style.transform = 'scale(1)';
            }, 150);
        }
    }
    
    // ======== تحديث مصادر البيانات ========
    updateDataSources() {
        // تحديث بيانات الأقمار الصناعية
        this.animateValue('satelliteData', 0, 2847, 2000);
        
        // تحديث بيانات وسائل التواصل الاجتماعي
        this.animateValue('socialData', 0, 12400, 2000, true);
        
        // تحديث بيانات محطات الأرصاد
        this.updateElement('weatherData', '32°');
        
        // تحديث بيانات الأسواق
        this.animateValue('marketData', 0, 47, 1500);
    }
    
    // ======== تحديث توقعات الأسعار الإقليمية ========
    updateRegionalForecast() {
        const prices = this.state.data.prices.regions || {};
        const avgPrice = Object.values(prices).reduce((sum, price) => sum + price, 0) / Object.keys(prices).length;
        const expectedPrice = avgPrice * 0.99; // توقع انخفاض بنسبة 1%
        
        this.updateElement('avgWeeklyRegionalPrice', `${avgPrice.toFixed(2)} ج`);
        this.updateElement('expectedRegionalPrice', `${expectedPrice.toFixed(2)} ج`);
        
        document.getElementById('regionalPriceInsight').textContent = 
            'من مصادر داخلية + تحليل السوق الرقمي (Tridge + تقارير محلية)';
    }
    
    // ======== تحديث الرسوم البيانية ========
    updateCharts() {
        // تحديث رسم بياني الأسعار
        if (this.state.charts.priceChart) {
            this.state.charts.priceChart.data.labels = Object.keys(this.state.data.prices.regions || {});
            this.state.charts.priceChart.data.datasets[0].data = Object.values(this.state.data.prices.regions || {});
            this.state.charts.priceChart.update('active');
        }
        
        // تحديث رسم بياني الكميات
        if (this.state.charts.quantityChart) {
            this.state.charts.quantityChart.data.labels = Object.keys(this.state.data.prices.regions || {});
            this.state.charts.quantityChart.data.datasets[0].data = this.state.data.regions.map(r => r.quantity);
            this.state.charts.quantityChart.update('active');
        }
        
        // تحديث رسم بياني الاتجاه
        if (this.state.charts.trendChart) {
            this.state.charts.trendChart.data.datasets[0].data = this.state.data.prices.historical || [];
            this.state.charts.trendChart.update('active');
        }
    }
    
    // ======== إعداد أحداث لوحة التحكم ========
    setupControlPanelEvents() {
        // زر تحديث البيانات
        document.querySelector('[onclick="updateAllData()"]')?.addEventListener('click', () => {
            this.updateAllData();
        });
        
        // زر تصدير البيانات
        document.querySelector('[onclick="exportData()"]')?.addEventListener('click', () => {
            this.exportData();
        });
        
        // زر التحليلات المتقدمة
        document.querySelector('[onclick="showAnalytics()"]')?.addEventListener('click', () => {
            this.showAnalytics();
        });
        
        // زر إنشاء التقرير
        document.querySelector('[onclick="generateReport()"]')?.addEventListener('click', () => {
            this.generateReport();
        });
        
        // زر الإعدادات
        document.querySelector('[onclick="showSettings()"]')?.addEventListener('click', () => {
            this.showSettings();
        });
        
        // أزرار التحكم في الخريطة
        this.setupMapControls();
    }
    
    // ======== إعداد أزرار التحكم في الخريطة ========
    setupMapControls() {
        // زر الموقع الحالي
        document.querySelector('[onclick="getCurrentLocation()"]')?.addEventListener('click', () => {
            this.getCurrentLocation();
        });
        
        // زر إضافة المزارع
        document.querySelector('[onclick="addMangoFarms()"]')?.addEventListener('click', () => {
            this.addMangoFarms();
        });
        
        // زر إظهار الأسواق
        document.querySelector('[onclick="showMarkets()"]')?.addEventListener('click', () => {
            this.showMarkets();
        });
        
        // زر مسح الخريطة
        document.querySelector('[onclick="clearMap()"]')?.addEventListener('click', () => {
            this.clearMap();
        });
        
        // زر البحث في الخريطة
        const searchButton = document.querySelector('[onclick="searchLocation()"]');
        const searchInput = document.getElementById('searchLocation');
        
        if (searchButton && searchInput) {
            searchButton.addEventListener('click', () => {
                this.searchLocation(searchInput.value);
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.searchLocation(searchInput.value);
                }
            });
        }
    }
    
    // ======== تحديث جميع البيانات ========
    async updateAllData() {
        this.showLoader(true);
        this.showUpdateIndicator(true);
        
        try {
            await this.fetchInitialData();
            this.showNotification('✅ تم تحديث كافة البيانات بنجاح!', 'success');
        } catch (error) {
            console.error('خطأ في تحديث البيانات:', error);
            this.showNotification('❌ فشل تحديث البيانات', 'error');
        } finally {
            this.showLoader(false);
            this.showUpdateIndicator(false);
        }
    }
    
    // ======== تصدير البيانات ========
    exportData() {
        try {
            // إنشاء محتوى ملف CSV
            const headers = [
                'الصنف', 'الاسم العلمي', 'المنطقة', 'المحافظة', 'المدينة', 
                'المساحة (فدان)', 'الجودة', 'الإنتاجية (طن/فدان)', 'الموسم', 'طريقة الري'
            ];
            
            const rows = this.state.data.mangoDatabase.map(item => [
                item.variety,
                item.scientificName,
                item.region,
                item.governorate,
                item.city,
                item.area,
                item.quality,
                item.productivity,
                item.season,
                item.irrigation
            ]);
            
            // إنشاء ملف CSV
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');
            
            // إنشاء رابط التحميل
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `بيانات_مانجو_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            this.showNotification('📥 تم تصدير البيانات بنجاح', 'success');
        } catch (error) {
            console.error('خطأ في تصدير البيانات:', error);
            this.showNotification('❌ فشل تصدير البيانات', 'error');
        }
    }
    
    // ======== عرض التحليلات المتقدمة ========
    showAnalytics() {
        // إنشاء نافذة منبثقة للتحليلات
        const modal = this.createModal('التحليلات المتقدمة', this.generateAnalyticsContent());
        document.body.appendChild(modal);
        
        // تهيئة الرسوم البيانية داخل النافذة المنبثقة
        setTimeout(() => {
            this.initializeAnalyticsCharts();
        }, 100);
    }
    
    // ======== إنشاء محتوى التحليلات ========
    generateAnalyticsContent() {
        return `
            <div class="analytics-container">
                <div class="grid grid-2 gap-6">
                    <div class="card">
                        <h3 class="text-xl font-bold mb-4">توزيع الأصناف حسب الجودة</h3>
                        <canvas id="qualityDistributionChart" width="400" height="300"></canvas>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-bold mb-4">العلاقة بين المساحة والإنتاجية</h3>
                        <canvas id="areaProductivityChart" width="400" height="300"></canvas>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-bold mb-4">توزيع المناطق الجغرافية</h3>
                        <canvas id="geographicDistributionChart" width="400" height="300"></canvas>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-bold mb-4">تحليل الربحية</h3>
                        <canvas id="profitabilityChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ======== تهيئة رسوم بيانية التحليلات ========
    initializeAnalyticsCharts() {
        // توزيع الأصناف حسب الجودة
        const qualityData = this.state.data.mangoDatabase.reduce((acc, item) => {
            acc[item.quality] = (acc[item.quality] || 0) + 1;
            return acc;
        }, {});
        
        new Chart(document.getElementById('qualityDistributionChart'), {
            type: 'pie',
            data: {
                labels: Object.keys(qualityData),
                datasets: [{
                    data: Object.values(qualityData),
                    backgroundColor: [
                        'rgba(79, 172, 254, 0.8)',
                        'rgba(240, 147, 251, 0.8)',
                        'rgba(251, 146, 60, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#e2e8f0',
                            font: {
                                family: 'Cairo, sans-serif'
                            }
                        }
                    }
                }
            }
        });
        
        // العلاقة بين المساحة والإنتاجية
        const areaProductivityData = this.state.data.mangoDatabase.map(item => ({
            x: item.area,
            y: item.productivity
        }));
        
        new Chart(document.getElementById('areaProductivityChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'المساحة مقابل الإنتاجية',
                    data: areaProductivityData,
                    backgroundColor: 'rgba(79, 172, 254, 0.6)'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'المساحة (فدان)',
                            color: '#e2e8f0'
                        },
                        ticks: {
                            color: '#e2e8f0'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'الإنتاجية (طن/فدان)',
                            color: '#e2e8f0'
                        },
                        ticks: {
                            color: '#e2e8f0'
                        }
                    }
                }
            }
        });
        
        // توزيع المناطق الجغرافية
        const regionData = this.state.data.mangoDatabase.reduce((acc, item) => {
            acc[item.region] = (acc[item.region] || 0) + 1;
            return acc;
        }, {});
        
        new Chart(document.getElementById('geographicDistributionChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(regionData),
                datasets: [{
                    label: 'عدد المزارع',
                    data: Object.values(regionData),
                    backgroundColor: 'rgba(79, 172, 254, 0.8)'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#e2e8f0'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#e2e8f0'
                        }
                    }
                }
            }
        });
        
        // تحليل الربحية
        const avgPrice = this.state.data.prices.current || 0;
        const profitabilityData = this.state.data.mangoDatabase.map(item => ({
            region: item.region,
            profitability: (item.productivity * avgPrice * item.area) - (item.area * 5000) // إيرادات - تكاليف
        }));
        
        new Chart(document.getElementById('profitabilityChart'), {
            type: 'bar',
            data: {
                labels: profitabilityData.map(item => item.region),
                datasets: [{
                    label: 'الربحية (جنيه)',
                    data: profitabilityData.map(item => item.profitability),
                    backgroundColor: profitabilityData.map(item => 
                        item.profitability > 0 ? 'rgba(79, 172, 254, 0.8)' : 'rgba(239, 68, 68, 0.8)'
                    )
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        ticks: {
                            color: '#e2e8f0'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#e2e8f0'
                        }
                    }
                }
            }
        });
    }
    
    // ======== إنشاء تقرير ========
    generateReport() {
        this.showLoader(true);
        
        try {
            // إنشاء محتوى التقرير
            const reportContent = this.generateReportContent();
            
            // إنشاء نافذة منبثقة لعرض التقرير
            const modal = this.createModal('تقرير شامل', reportContent);
            document.body.appendChild(modal);
            
            this.showNotification('📝 تم إنشاء التقرير بنجاح', 'success');
        } catch (error) {
            console.error('خطأ في إنشاء التقرير:', error);
            this.showNotification('❌ فشل إنشاء التقرير', 'error');
        } finally {
            this.showLoader(false);
        }
    }
    
    // ======== إنشاء محتوى التقرير ========
    generateReportContent() {
        const stats = this.calculateStatistics();
        const date = new Date().toLocaleDateString('ar-EG', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        return `
            <div class="report-container">
                <div class="report-header text-center mb-6">
                    <h2 class="text-2xl font-bold">تقرير نظام تتبع المانجو الكيت</h2>
                    <p class="text-secondary">تاريخ: ${date}</p>
                </div>
                
                <div class="report-summary mb-6">
                    <h3 class="text-xl font-bold mb-3">ملخص التنفيذي</h3>
                    <p>يغطي هذا التقرير حالة مزارع المانجو في المناطق المصرية الرئيسية، مع تحليل شامل للإنتاجية والأسعار والجودة.</p>
                </div>
                
                <div class="report-stats grid grid-2 gap-4 mb-6">
                    <div class="stat-card">
                        <h4 class="font-bold mb-2">إجمالي المناطق</h4>
                        <p class="text-3xl font-bold text-accent-blue">${stats.totalRegions}</p>
                    </div>
                    <div class="stat-card">
                        <h4 class="font-bold mb-2">المزارع المتاحة</h4>
                        <p class="text-3xl font-bold text-success">${stats.availableCount}</p>
                    </div>
                    <div class="stat-card">
                        <h4 class="font-bold mb-2">إجمالي المزارع</h4>
                        <p class="text-3xl font-bold text-warning">${stats.totalFarms}</p>
                    </div>
                    <div class="stat-card">
                        <h4 class="font-bold mb-2">الإنتاج المتوقع</h4>
                        <p class="text-3xl font-bold text-accent-green">${stats.totalQuantity.toLocaleString('ar-EG')} طن</p>
                    </div>
                </div>
                
                <div class="report-section mb-6">
                    <h3 class="text-xl font-bold mb-3">تحليل الأسعار</h3>
                    <p>متوسط السعر الحالي: <strong>${stats.averagePrice} جنيه/كجم</strong></p>
                    <p>توقعات الأسعار للأسبوع القادم: <strong>${(stats.averagePrice * 1.02).toFixed(2)} جنيه/كجم</strong></p>
                </div>
                
                <div class="report-section mb-6">
                    <h3 class="text-xl font-bold mb-3">توصيات</h3>
                    <ul class="list-disc pr-5">
                        <li>زيادة الاهتمام بأصناف المانجو عالية الجودة</li>
                        <li>تحسين طرق الري في المناطق الجافة</li>
                        <li>التوسع في زراعة الأصناف المطلوبة للتصدير</li>
                        <li>تطبيق تقنيات الزراعة الذكية لزيادة الإنتاجية</li>
                    </ul>
                </div>
                
                <div class="report-footer text-center mt-6 pt-4 border-t">
                    <p>تم إنشاء هذا التقرير بواسطة نظام تتبع المانجو الكيت المتقدم</p>
                    <p class="text-sm text-secondary">جميع الحقوق محفوظة © ${new Date().getFullYear()}</p>
                </div>
            </div>
        `;
    }
    
    // ======== عرض الإعدادات ========
    showSettings() {
        const settingsContent = `
            <div class="settings-container">
                <div class="settings-section mb-6">
                    <h3 class="text-xl font-bold mb-4">إعدادات عامة</h3>
                    <div class="form-group mb-4">
                        <label class="form-label">فترة التحديث التلقائي (بالثانية)</label>
                        <select id="updateInterval" class="form-select">
                            <option value="10000">10 ثواني</option>
                            <option value="30000" selected>30 ثانية</option>
                            <option value="60000">دقيقة واحدة</option>
                            <option value="300000">5 دقائق</option>
                        </select>
                    </div>
                    <div class="form-group mb-4">
                        <label class="form-label">اللغة</label>
                        <select id="language" class="form-select">
                            <option value="ar" selected>العربية</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section mb-6">
                    <h3 class="text-xl font-bold mb-4">إعدادات الخريطة</h3>
                    <div class="form-group mb-4">
                        <label class="form-label">نوع الخريطة</label>
                        <select id="mapType" class="form-select">
                            <option value="openstreetmap" selected>OpenStreetMap</option>
                            <option value="satellite">القمر الصناعي</option>
                            <option value="terrain">التضاريس</option>
                        </select>
                    </div>
                    <div class="form-group mb-4">
                        <label class="form-label">مستوى التكبير الافتراضي</label>
                        <input type="range" id="defaultZoom" class="form-input" min="1" max="18" value="6">
                    </div>
                </div>
                
                <div class="settings-section mb-6">
                    <h3 class="text-xl font-bold mb-4">إعدادات الإشعارات</h3>
                    <div class="form-check mb-3">
                        <input type="checkbox" id="priceAlerts" class="form-check-input" checked>
                        <label class="form-check-label" for="priceAlerts">تنبيهات تغير الأسعار</label>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" id="weatherAlerts" class="form-check-input" checked>
                        <label class="form-check-label" for="weatherAlerts">تنبيهات الأحوال الجوية</label>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" id="harvestAlerts" class="form-check-input">
                        <label class="form-check-label" for="harvestAlerts">تنبيهات مواسم الحصاد</label>
                    </div>
                </div>
                
                <div class="text-center">
                    <button class="btn btn-primary" onclick="app.saveSettings()">حفظ الإعدادات</button>
                    <button class="btn btn-secondary ml-2" onclick="app.closeModal()">إلغاء</button>
                </div>
            </div>
        `;
        
        const modal = this.createModal('الإعدادات', settingsContent);
        document.body.appendChild(modal);
        
        // تعيين القيم الحالية
        document.getElementById('updateInterval').value = this.config.updateInterval;
        document.getElementById('defaultZoom').value = this.config.mapZoom;
    }
    
    // ======== حفظ الإعدادات ========
    saveSettings() {
        // تحديث إعدادات التطبيق
        this.config.updateInterval = parseInt(document.getElementById('updateInterval').value);
        this.config.mapZoom = parseInt(document.getElementById('defaultZoom').value);
        
        // حفظ الإعدادات في localStorage
        localStorage.setItem('mangoTrackingSettings', JSON.stringify(this.config));
        
        // إعادة تشغيل التحديثات التلقائية بالفترة الجديدة
        clearInterval(this.updateInterval);
        this.startAutoUpdates();
        
        // إغلاق النافذة المنبثقة
        this.closeModal();
        
        this.showNotification('✅ تم حفظ الإعدادات بنجاح', 'success');
    }
    
    // ======== إغلاق النافذة المنبثقة ========
    closeModal() {
        const modal = document.querySelector('.modal');
        if (modal) {
            modal.remove();
        }
    }
    
    // ======== إجراء البحث ========
    performSearch() {
        this.showLoading(true);
        
        // استخدام Web Worker للبحث في الخلفية إذا كانت البيانات كبيرة
        if (window.Worker && this.state.data.mangoDatabase.length > 1000) {
            this.performSearchWithWorker();
        } else {
            this.performSearchDirectly();
        }
    }
    
    // ======== إجراء البحث مباشرة ========
    performSearchDirectly() {
        setTimeout(() => {
            const variety = document.getElementById('mangoVariety').value.toLowerCase();
            const region = document.getElementById('region').value;
            const quality = document.getElementById('quality').value;
            const season = document.getElementById('season').value;
            const irrigation = document.getElementById('irrigation').value;
            
            const areaMin = parseInt(document.getElementById('areaMin').value);
            const areaMax = parseInt(document.getElementById('areaMax').value);
            const productivityMin = parseInt(document.getElementById('productivityMin').value);
            const productivityMax = parseInt(document.getElementById('productivityMax').value);
            
            // فلترة البيانات
            this.state.data.filteredResults = this.state.data.mangoDatabase.filter(mango => {
                const matchesVariety = !variety || mango.variety.toLowerCase().includes(variety);
                const matchesRegion = !region || mango.region === region;
                const matchesQuality = !quality || mango.quality === quality;
                const matchesSeason = !season || mango.season === season;
                const matchesIrrigation = !irrigation || mango.irrigation === irrigation;
                const matchesArea = mango.area >= areaMin && mango.area <= areaMax;
                const matchesProductivity = mango.productivity >= productivityMin && mango.productivity <= productivityMax;
                
                return matchesVariety && matchesRegion && matchesQuality && 
                       matchesSeason && matchesIrrigation && matchesArea && matchesProductivity;
            });
            
            this.hideLoading();
            this.displayResults(this.state.data.filteredResults);
        }, 300);
    }
    
    // ======== إجراء البحث باستخدام Web Worker ========
    performSearchWithWorker() {
        // إنشاء Web Worker للبحث
        const workerCode = `
            self.onmessage = function(e) {
                const { 
                    mangoDatabase, variety, region, quality, season, irrigation,
                    areaMin, areaMax, productivityMin, productivityMax 
                } = e.data;
                
                const filteredResults = mangoDatabase.filter(mango => {
                    const matchesVariety = !variety || mango.variety.toLowerCase().includes(variety);
                    const matchesRegion = !region || mango.region === region;
                    const matchesQuality = !quality || mango.quality === quality;
                    const matchesSeason = !season || mango.season === season;
                    const matchesIrrigation = !irrigation || mango.irrigation === irrigation;
                    const matchesArea = mango.area >= areaMin && mango.area <= areaMax;
                    const matchesProductivity = mango.productivity >= productivityMin && mango.productivity <= productivityMax;
                    
                    return matchesVariety && matchesRegion && matchesQuality && 
                           matchesSeason && matchesIrrigation && matchesArea && matchesProductivity;
                });
                
                self.postMessage({ filteredResults });
            };
        `;
        
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const worker = new Worker(URL.createObjectURL(blob));
        
        // إرسال البيانات إلى العامل
        worker.postMessage({
            mangoDatabase: this.state.data.mangoDatabase,
            variety: document.getElementById('mangoVariety').value.toLowerCase(),
            region: document.getElementById('region').value,
            quality: document.getElementById('quality').value,
            season: document.getElementById('season').value,
            irrigation: document.getElementById('irrigation').value,
            areaMin: parseInt(document.getElementById('areaMin').value),
            areaMax: parseInt(document.getElementById('areaMax').value),
            productivityMin: parseInt(document.getElementById('productivityMin').value),
            productivityMax: parseInt(document.getElementById('productivityMax').value)
        });
        
        // استقبال النتائج
        worker.onmessage = (e) => {
            this.state.data.filteredResults = e.data.filteredResults;
            this.hideLoading();
            this.displayResults(this.state.data.filteredResults);
            worker.terminate();
        };
    }
    
    // ======== عرض النتائج ========
    displayResults(results) {
        const resultsGrid = document.getElementById('resultsGrid');
        const resultsCount = document.getElementById('resultsCount');
        const emptyState = document.getElementById('emptyState');
        
        if (results.length === 0) {
            this.showEmptyState();
            return;
        }
        
        this.hideEmptyState();
        
        // ترتيب النتائج
        results.sort((a, b) => {
            switch(this.state.ui.currentSort) {
                case 'area':
                    return b.area - a.area;
                case 'productivity':
                    return b.productivity - a.productivity;
                case 'name':
                    return a.variety.localeCompare(b.variety, 'ar');
                default:
                    return 0;
            }
        });
        
        resultsCount.textContent = `عرض ${results.length} نتيجة`;
        
        // استخدام DocumentFragment لتحسين الأداء
        const fragment = document.createDocumentFragment();
        
        results.forEach(mango => {
            const card = this.createResultCard(mango);
            fragment.appendChild(card);
        });
        
        // إضافة النتائج دفعة واحدة
        resultsGrid.innerHTML = '';
        resultsGrid.appendChild(fragment);
        
        // تطبيق تأثيرات الحركة
        this.applyCardAnimations();
    }
    
    // ======== إنشاء بطاقة نتيجة ========
    createResultCard(mango) {
        const card = document.createElement('div');
        card.className = 'result-card ripple-effect';
        card.addEventListener('click', (e) => this.createRipple(e, card));
        
        card.innerHTML = `
            <div class="card-header">
                <div class="mango-info">
                    <h3 class="mango-variety">${mango.variety}</h3>
                    <p class="mango-scientific-name">${mango.scientificName}</p>
                </div>
                <span class="quality-badge quality-${this.getQualityClass(mango.quality)}">${mango.quality}</span>
            </div>
            <div class="card-content">
                <div class="location-section">
                    <h4 class="location-title">
                        <i class="fas fa-map-marker-alt"></i>
                        معلومات المنطقة
                    </h4>
                    <div class="location-details">
                        <div class="location-item">
                            <span class="location-label">المحافظة:</span>
                            <span class="location-value">${mango.governorate}</span>
                        </div>
                        <div class="location-item">
                            <span class="location-label">المدينة:</span>
                            <span class="location-value">${mango.city}</span>
                        </div>
                        <div class="location-item">
                            <span class="location-label">المساحة:</span>
                            <span class="location-value area-highlight">${mango.area} فدان</span>
                        </div>
                        <div class="location-item">
                            <span class="location-label">طريقة الري:</span>
                            <span class="location-value">${mango.irrigation}</span>
                        </div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${mango.productivity}</div>
                        <div class="stat-label">طن/فدان</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${mango.averageWeight}</div>
                        <div class="stat-label">جرام/ثمرة</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${mango.sugarContent}%</div>
                        <div class="stat-label">محتوى السكر</div>
                    </div>
                </div>
                <div class="characteristics">
                    <h5 class="characteristics-title">خصائص مميزة</h5>
                    <div class="characteristics-tags">
                        ${mango.characteristics.map(char => `<span class="characteristic-tag">${char}</span>`).join('')}
                    </div>
                </div>
            </div>
        `;
        
        return card;
    }
    
    // ======== تطبيق تأثيرات الحركة على البطاقات ========
    applyCardAnimations() {
        const cards = document.querySelectorAll('.result-card');
        
        cards.forEach((card, index) => {
            // إضافة تأثير ظهور تدريجي
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    }
    
    // ======== الحصول على فئة الجودة ========
    getQualityClass(quality) {
        const qualityMap = {
            'ممتاز': 'excellent',
            'تصدير': 'premium',
            'جيد جداً': 'good',
            'جيد': 'good'
        };
        return qualityMap[quality] || 'good';
    }
    
    // ======== عرض حالة التحميل ========
    showLoading(show) {
        const loadingContainer = document.getElementById('loadingContainer');
        const resultsGrid = document.getElementById('resultsGrid');
        const emptyState = document.getElementById('emptyState');
        
        if (show) {
            loadingContainer.style.display = 'block';
            resultsGrid.style.display = 'none';
            emptyState.style.display = 'none';
        } else {
            loadingContainer.style.display = 'none';
            resultsGrid.style.display = 'grid';
        }
    }
    
    // ======== عرض حالة فارغة ========
    showEmptyState() {
        const emptyState = document.getElementById('emptyState');
        const resultsGrid = document.getElementById('resultsGrid');
        const resultsCount = document.getElementById('resultsCount');
        
        emptyState.style.display = 'block';
        resultsGrid.style.display = 'none';
        resultsCount.textContent = 'لا توجد نتائج';
    }
    
    // ======== إخفاء حالة فارغة ========
    hideEmptyState() {
        const emptyState = document.getElementById('emptyState');
        emptyState.style.display = 'none';
    }
    
    // ======== إنشاء تأثير الموجة ========
    createRipple(event, element) {
        const ripple = document.createElement('div');
        ripple.classList.add('ripple');
        
        const rect = element.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = event.clientX - rect.left - size / 2;
        const y = event.clientY - rect.top - size / 2;
        
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        
        element.appendChild(ripple);
        
        setTimeout(() => {
            ripple.remove();
        }, 600);
    }
    
    // ======== تحديث قيم الـ sliders ========
    updateSliderValues() {
        document.getElementById('areaMinValue').textContent = document.getElementById('areaMin').value;
        document.getElementById('areaMaxValue').textContent = document.getElementById('areaMax').value;
        document.getElementById('productivityMinValue').textContent = document.getElementById('productivityMin').value;
        document.getElementById('productivityMaxValue').textContent = document.getElementById('productivityMax').value;
    }
    
    // ======== إظهار المؤشر العام ========
    showLoader(show) {
        const loader = document.getElementById('globalLoading');
        if (loader) {
            loader.style.display = show ? 'flex' : 'none';
        }
    }
    
    // ======== إظهار مؤشر التحديث ========
    showUpdateIndicator(show) {
        const indicator = document.getElementById('updateIndicator');
        if (indicator) {
            indicator.style.display = show ? 'block' : 'none';
        }
    }
    
    // ======== حفظ البيانات محلياً ========
    saveDataLocally() {
        try {
            const dataToSave = {
                ...this.state.data,
                lastUpdate: this.state.ui.lastUpdate
            };
            
            localStorage.setItem('mangoTrackingData', JSON.stringify(dataToSave));
            console.log('💾 تم حفظ البيانات محلياً');
        } catch (error) {
            console.error('خطأ في حفظ البيانات محلياً:', error);
        }
    }
    
    // ======== حفظ حالة التطبيق ========
    saveAppState() {
        const appState = {
            ui: this.state.ui,
            config: this.config
        };
        
        localStorage.setItem('mangoTrackingAppState', JSON.stringify(appState));
    }
    
    // ======== تحميل حالة التطبيق ========
    loadAppState() {
        try {
            const savedState = localStorage.getItem('mangoTrackingAppState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                this.state.ui = { ...this.state.ui, ...parsedState.ui };
                this.config = { ...this.config, ...parsedState.config };
            }
        } catch (error) {
            console.error('خطأ في تحميل حالة التطبيق:', error);
        }
    }
    
    // ======== إظهار إشعار ========
    showNotification(message, type = 'info') {
        // إنشاء عنصر الإشعار
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <span>${message}</span>
                <button class="notification-close">&times;</button>
            </div>
        `;
        
        // إضافة الإشعار للصفحة
        document.body.appendChild(notification);
        
        // إظهار الإشعار مع تأثير حركي
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
            notification.style.opacity = '1';
        }, 10);
        
        // إزالة الإشعار بعد فترة
        const autoRemove = setTimeout(() => {
            this.removeNotification(notification);
        }, 5000);
        
        // إغلاق الإشعار عند النقر على زر الإغلاق
        notification.querySelector('.notification-close').addEventListener('click', () => {
            clearTimeout(autoRemove);
            this.removeNotification(notification);
        });
    }
    
    // ======== إزالة إشعار ========
    removeNotification(notification) {
        notification.style.transform = 'translateX(100%)';
        notification.style.opacity = '0';
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }
    
    // ======== إظهار رسالة خطأ ========
    showError(message) {
        this.showNotification(message, 'error');
    }
    
    // ======== إنشاء نافذة منبثقة ========
    createModal(title, content) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">${title}</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
            </div>
        `;
        
        // إغلاق النافذة عند النقر على زر الإغلاق
        modal.querySelector('.modal-close').addEventListener('click', () => {
            modal.remove();
        });
        
        // إغلاق النافذة عند النقر خارجها
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        return modal;
    }
    
    // ======== تحريك القيم ========
    animateValue(id, start, end, duration, isK = false) {
        const element = document.getElementById(id);
        if (!element) return;
        
        const range = end - start;
        const increment = range / (duration / 16);
        let current = start;
        
        const timer = setInterval(() => {
            current += increment;
            
            if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                current = end;
                clearInterval(timer);
            }
            
            element.textContent = isK ? 
                Math.floor(current).toLocaleString() : 
                Math.floor(current);
        }, 16);
    }
    
    // ======== تحديث الساعة ========
    updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        const clockElement = document.getElementById('clock');
        if (clockElement) {
            clockElement.textContent = timeString;
        }
    }
    
    // ======== إعداد تأثيرات التمرير ========
    setupScrollEffects() {
        // تأثير الشريط العلوي عند التمرير
        let lastScrollTop = 0;
        const header = document.querySelector('.header');
        
        window.addEventListener('scroll', () => {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (scrollTop > lastScrollTop && scrollTop > 100) {
                header.style.transform = 'translateY(-100%)';
            } else {
                header.style.transform = 'translateY(0)';
            }
            
            lastScrollTop = scrollTop;
        });
        
        // تأثير الظهور عند التمرير للعناصر
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -100px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('scroll-visible');
                }
            });
        }, observerOptions);
        
        document.querySelectorAll('.card').forEach(card => {
            observer.observe(card);
        });
    }
    
    // ======== إعداد تأثيرات الحركة ========
    setupAnimationEffects() {
        // تأثير الخلفية المتحركة
        this.animateBackground();
        
        // تأثير النبض للعناصر المهمة
        document.querySelectorAll('.animate-pulse').forEach(element => {
            element.style.animation = 'pulse 2s infinite';
        });
    }
    
    // ======== تحريك الخلفية ========
    animateBackground() {
        const body = document.body;
        let position = 0;
        
        const animate = () => {
            position += 0.1;
            body.style.backgroundPosition = `${position}px ${position}px`;
            requestAnimationFrame(animate);
        };
        
        animate();
    }
    
    // ======== دوال مساعدة ========
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    throttle(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    }
    
    // ======== دوال الخريطة ========
    getCurrentLocation() {
        if (!navigator.geolocation) {
            this.showNotification('المتصفح لا يدعم تحديد الموقع', 'error');
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;
                this.state.map.setView([latitude, longitude], 13);
                L.marker([latitude, longitude])
                    .addTo(this.state.map)
                    .bindPopup('📍 موقعك الحالي')
                    .openPopup();
            },
            () => {
                this.showNotification('تعذر تحديد الموقع', 'error');
            }
        );
    }
    
    addMangoFarms() {
        const farms = [
            { lat: 30.65, lon: 30.90, name: "مزرعة البحيرة" },
            { lat: 30.95, lon: 31.15, name: "مزرعة الجيزة" },
            { lat: 30.30, lon: 31.25, name: "مزرعة الشرقية" }
        ];
        
        farms.forEach(farm => {
            L.marker([farm.lat, farm.lon], { icon: this.farmIcon })
                .addTo(this.state.map)
                .bindPopup(`<strong>${farm.name}</strong>`);
        });
    }
    
    showMarkets() {
        const markets = [
            { lat: 30.0444, lon: 31.2357, name: "سوق العبور" },
            { lat: 30.1200, lon: 31.3200, name: "سوق 6 أكتوبر" }
        ];
        
        markets.forEach(market => {
            L.marker([market.lat, market.lon], { icon: this.marketIcon })
                .addTo(this.state.map)
                .bindPopup(`<strong>${market.name}</strong>`);
        });
    }
    
    clearMap() {
        this.state.map.eachLayer(layer => {
            if (layer instanceof L.Marker || layer instanceof L.Circle) {
                this.state.map.removeLayer(layer);
            }
        });
    }
    
    searchLocation(query) {
        if (!query) {
            this.showNotification('يرجى إدخال موقع للبحث', 'warning');
            return;
        }
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                if (data.length > 0) {
                    const { lat, lon, display_name } = data[0];
                    this.state.map.setView([lat, lon], 13);
                    L.marker([lat, lon])
                        .addTo(this.state.map)
                        .bindPopup(`<strong>${display_name}</strong>`)
                        .openPopup();
                } else {
                    this.showNotification('لم يتم العثور على الموقع', 'warning');
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                this.showNotification('حدث خطأ أثناء البحث', 'error');
            });
    }
    
    // ======== دعم توقعات الأسعار ========
    showForecast(period) {
        const data = this.state.data.forecasts[period];
        if (!data) return;
        
        // تحديث الأزرار
        document.querySelectorAll('.forecast-section .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // تحديث النتائج
        document.getElementById('forecastPrice').textContent = `${data.price.toFixed(1)} جنيه/كجم`;
        document.getElementById('forecastConfidence').textContent = `${data.confidence}%`;
        
        // تحديث الرسم البياني
        const ctx = document.getElementById('forecastChart').getContext('2d');
        
        if (this.state.charts.forecastChart) {
            this.state.charts.forecastChart.destroy();
        }
        
        this.state.charts.forecastChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'السعر المتوقع',
                    data: data.values,
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243, 156, 18, 0.2)',
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#e67e22',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'جنيه/كيلو',
                            color: '#e2e8f0'
                        },
                        ticks: {
                            color: '#e2e8f0'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#e2e8f0'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            family: 'Cairo, sans-serif',
                            size: 14
                        },
                        bodyFont: {
                            family: 'Cairo, sans-serif',
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8
                    }
                }
            }
        });
    }
    
    // ======== الحصول على قاعدة بيانات المانجو ========
    getMangoDatabase() {
        return [
            {
                id: 1,
                variety: 'كيت',
                scientificName: 'Mangifera indica var. Keitt',
                region: 'الإسماعيلية',
                area: 850,
                quality: 'ممتاز',
                productivity: 18.5,
                season: 'متأخر',
                irrigation: 'تنقيط',
                governorate: 'الإسماعيلية',
                city: 'أبو صوير',
                characteristics: ['حجم كبير', 'مقاوم للأمراض', 'صالح للتصدير', 'نكهة مميزة'],
                averageWeight: 450,
                sugarContent: 16.8,
                shelfLife: 21
            },
            {
                id: 2,
                variety: 'عويس',
                scientificName: 'Mangifera indica var. Ewais',
                region: 'الشرقية',
                area: 1200,
                quality: 'ممتاز',
                productivity: 22.3,
                season: 'مبكر',
                irrigation: 'تنقيط',
                governorate: 'الشرقية',
                city: 'الزقازيق',
                characteristics: ['حلاوة عالية', 'لون جذاب', 'مبكر النضج', 'محبوب محلياً'],
                averageWeight: 280,
                sugarContent: 19.2,
                shelfLife: 14
            },
            {
                id: 3,
                variety: 'زبدية',
                scientificName: 'Mangifera indica var. Zebdia',
                region: 'البحيرة',
                area: 950,
                quality: 'جيد جداً',
                productivity: 16.8,
                season: 'منتصف الموسم',
                irrigation: 'رش',
                governorate: 'البحيرة',
                city: 'النوبارية',
                characteristics: ['قوام كريمي', 'طعم حلو', 'مقاومة للنقل', 'تخزين جيد'],
                averageWeight: 320,
                sugarContent: 17.5,
                shelfLife: 18
            },
            {
                id: 4,
                variety: 'سكري',
                scientificName: 'Mangifera indica var. Succary',
                region: 'الجيزة',
                area: 650,
                quality: 'تصدير',
                productivity: 20.1,
                season: 'مبكر',
                irrigation: 'تنقيط',
                governorate: 'الجيزة',
                city: 'العياط',
                characteristics: ['سكريات عالية', 'لون ذهبي', 'رائحة عطرة', 'جودة تصدير'],
                averageWeight: 380,
                sugarContent: 21.3,
                shelfLife: 16
            },
            {
                id: 5,
                variety: 'هندي',
                scientificName: 'Mangifera indica var. Hindi',
                region: 'القليوبية',
                area: 420,
                quality: 'جيد',
                productivity: 14.7,
                season: 'منتصف الموسم',
                irrigation: 'غمر',
                governorate: 'القليوبية',
                city: 'شبرا الخيمة',
                characteristics: ['حجم متوسط', 'طعم تقليدي', 'مناسب للعصائر', 'سعر اقتصادي'],
                averageWeight: 250,
                sugarContent: 15.8,
                shelfLife: 12
            },
            {
                id: 6,
                variety: 'تومي أتكينز',
                scientificName: 'Mangifera indica var. Tommy Atkins',
                region: 'المنوفية',
                area: 780,
                quality: 'تصدير',
                productivity: 19.4,
                season: 'منتصف الموسم',
                irrigation: 'تنقيط',
                governorate: 'المنوفية',
                city: 'شبين الكوم',
                characteristics: ['مقاوم للشحن', 'شكل جذاب', 'لون أحمر', 'جودة عالمية'],
                averageWeight: 420,
                sugarContent: 16.2,
                shelfLife: 25
            },
            {
                id: 7,
                variety: 'كنت',
                scientificName: 'Mangifera indica var. Kent',
                region: 'كفر الشيخ',
                area: 320,
                quality: 'ممتاز',
                productivity: 17.9,
                season: 'متأخر',
                irrigation: 'رش',
                governorate: 'كفر الشيخ',
                city: 'دسوق',
                characteristics: ['حجم كبير', 'قليل الألياف', 'طعم حلو', 'نضج متأخر'],
                averageWeight: 480,
                sugarContent: 18.1,
                shelfLife: 19
            },
            {
                id: 8,
                variety: 'هايدن',
                scientificName: 'Mangifera indica var. Haden',
                region: 'الغربية',
                area: 290,
                quality: 'جيد جداً',
                productivity: 15.6,
                season: 'مبكر',
                irrigation: 'محوري',
                governorate: 'الغربية',
                city: 'طنطا',
                characteristics: ['لون أحمر وردي', 'عطر قوي', 'طعم مميز', 'تاريخ عريق'],
                averageWeight: 350,
                sugarContent: 17.8,
                shelfLife: 15
            },
            {
                id: 9,
                variety: 'فونسو',
                scientificName: 'Mangifera indica var. Alphonso',
                region: 'الدقهلية',
                area: 180,
                quality: 'ممتاز',
                productivity: 16.3,
                season: 'مبكر',
                irrigation: 'تنقيط',
                governorate: 'الدقهلية',
                city: 'المنصورة',
                characteristics: ['ملك المانجو', 'طعم استثنائي', 'لب كثيف', 'جودة فائقة'],
                averageWeight: 300,
                sugarContent: 20.5,
                shelfLife: 14
            },
            {
                id: 10,
                variety: 'بالمر',
                scientificName: 'Mangifera indica var. Palmer',
                region: 'دمياط',
                area: 210,
                quality: 'جيد جداً',
                productivity: 18.8,
                season: 'منتصف الموسم',
                irrigation: 'تنقيط',
                governorate: 'دمياط',
                city: 'رأس البر',
                characteristics: ['مقاوم للرطوبة', 'إنتاجية عالية', 'تكيف ساحلي', 'نكهة متوازنة'],
                averageWeight: 380,
                sugarContent: 16.9,
                shelfLife: 17
            },
            {
                id: 11,
                variety: 'جلين',
                scientificName: 'Mangifera indica var. Glenn',
                region: 'شمال سيناء',
                area: 150,
                quality: 'جيد',
                productivity: 12.4,
                season: 'متأخر',
                irrigation: 'تنقيط',
                governorate: 'شمال سيناء',
                city: 'العريش',
                characteristics: ['مقاوم للجفاف', 'متكيف صحراوي', 'حجم صغير', 'طعم مركز'],
                averageWeight: 200,
                sugarContent: 18.7,
                shelfLife: 13
            },
            {
                id: 12,
                variety: 'كيو',
                scientificName: 'Mangifera indica var. Keo',
                region: 'جنوب سيناء',
                area: 85,
                quality: 'جيد جداً',
                productivity: 11.8,
                season: 'متأخر',
                irrigation: 'تنقيط',
                governorate: 'جنوب سيناء',
                city: 'طور سيناء',
                characteristics: ['تحمل الملوحة', 'زراعة عضوية', 'حجم متوسط', 'جودة طبيعية'],
                averageWeight: 270,
                sugarContent: 17.2,
                shelfLife: 16
            }
        ];
    }
}

// ======== تهيئة التطبيق عند تحميل الصفحة ========
document.addEventListener('DOMContentLoaded', () => {
    // إنشاء نسخة من التطبيق
    window.app = new MangoTrackingApp();
    
    // جعل الدوال العامة متاحة
    window.updateAllData = () => window.app.updateAllData();
    window.exportData = () => window.app.exportData();
    window.showAnalytics = () => window.app.showAnalytics();
    window.generateReport = () => window.app.generateReport();
    window.showSettings = () => window.app.showSettings();
    window.getCurrentLocation = () => window.app.getCurrentLocation();
    window.addMangoFarms = () => window.app.addMangoFarms();
    window.showMarkets = () => window.app.showMarkets();
    window.clearMap = () => window.app.clearMap();
    window.searchLocation = () => window.app.searchLocation(document.getElementById('searchLocation').value);
    window.showForecast = (period) => window.app.showForecast(period);
    window.saveSettings = () => window.app.saveSettings();
    window.closeModal = () => window.app.closeModal();
});

// ======== إضافة أنماط CSS للعناصر الديناميكية ========
const dynamicStyles = document.createElement('style');
dynamicStyles.textContent = `
    /* أنماط الإشعارات */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        transform: translateX(120%);
        transition: transform 0.3s ease, opacity 0.3s ease;
        opacity: 0;
        max-width: 300px;
    }
    
    .notification-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
    }
    
    .notification-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #666;
        margin-right: 10px;
    }
    
    .notification-info {
        border-right: 4px solid #3498db;
    }
    
    .notification-success {
        border-right: 4px solid #2ecc71;
    }
    
    .notification-warning {
        border-right: 4px solid #f39c12;
    }
    
    .notification-error {
        border-right: 4px solid #e74c3c;
    }
    
    /* أنماط النوافذ المنبثقة */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .modal.show {
        opacity: 1;
    }
    
    .modal-content {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }
    
    .modal.show .modal-content {
        transform: scale(1);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid var(--glass-border);
    }
    
    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
        transition: color 0.3s ease;
    }
    
    .modal-close:hover {
        color: var(--text-primary);
    }
    
    .modal-body {
        padding: 20px;
    }
    
    /* أنماط التمرير */
    .scroll-visible {
        opacity: 1 !important;
        transform: translateY(0) !important;
    }
    
    /* أنماط الساعة */
    #clock {
        font-weight: 600;
        color: var(--text-accent);
    }
`;

document.head.appendChild(dynamicStyles);


</script>





    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // إعداد الخريطة الأساسية
        let map = L.map('map').setView([30.4, 30.8], 9);
        let currentLayer = null;
        let markers = [];
        let overlays = {};
        let mangoFarms = [];
        let markets = [];

        // بيانات مناطق إنتاج المانجو
        const mangoRegions = [
            {
                id: 'sphinx_mango',
                name: 'مزارع المانجو - سفنكس',
                location: { lat: 29.9753, lng: 31.1376 },
                area: 420,
                production: 2100,
                farms: 28,
                varieties: ['كيت', 'كنت', 'عويس'],
                status: 'ممتاز',
                yield: 5.0,
                irrigationType: 'تنقيط'
            },
            {
                id: 'abu_ghalib_mango',
                name: 'مزارع المانجو - أبو غالب',
                location: { lat: 30.1200, lng: 30.9500 },
                area: 680,
                production: 3740,
                farms: 42,
                varieties: ['زبدة', 'فونس', 'كيت'],
                status: 'ممتاز',
                yield: 5.5,
                irrigationType: 'تنقيط'
            },
            {
                id: 'khatatba_mango',
                name: 'مزارع المانجو - الخطاطبة',
                location: { lat: 30.2650, lng: 30.7800 },
                area: 520,
                production: 2600,
                farms: 35,
                varieties: ['عويس', 'سكري', 'كنت'],
                status: 'جيد',
                yield: 5.0,
                irrigationType: 'رش ومحوري'
            },
            {
                id: 'sadat_mango',
                name: 'مزارع المانجو - السادات',
                location: { lat: 30.3708, lng: 30.6042 },
                area: 890,
                production: 5340,
                farms: 56,
                varieties: ['كيت', 'تومي أتكنز', 'كنت'],
                status: 'ممتاز',
                yield: 6.0,
                irrigationType: 'تنقيط'
            },
            {
                id: 'wadi_natrun_mango',
                name: 'مزارع المانجو - وادي النطرون',
                location: { lat: 30.3828, lng: 30.3467 },
                area: 750,
                production: 4125,
                farms: 48,
                varieties: ['زبدة', 'عويس', 'فونس'],
                status: 'ممتاز',
                yield: 5.5,
                irrigationType: 'تنقيط'
            },
            {
                id: 'naburiya_mango',
                name: 'مزارع المانجو - النابورية',
                location: { lat: 30.4200, lng: 30.1800 },
                area: 387,
                production: 1935,
                farms: 23,
                varieties: ['كيت', 'سكري', 'كنت'],
                status: 'جيد',
                yield: 5.0,
                irrigationType: 'رش'
            }
        ];

        // بيانات الأسواق ومراكز التسويق
        const marketCenters = [
            {
                name: 'سوق الجملة - السادات',
                location: { lat: 30.3708, lng: 30.6142 },
                type: 'سوق جملة',
                capacity: '500 طن/يوم'
            },
            {
                name: 'مركز تجميع وادي النطرون',
                location: { lat: 30.3828, lng: 30.3567 },
                type: 'مركز تجميع',
                capacity: '200 طن/يوم'
            },
            {
                name: 'سوق الخطاطبة المحلي',
                location: { lat: 30.2650, lng: 30.7900 },
                type: 'سوق محلي',
                capacity: '100 طن/يوم'
            }
        ];

        // طبقات الخريطة المختلفة
        const baseLayers = {
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri WorldImagery',
                maxZoom: 18
            }),
            hybrid: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri WorldImagery',
                maxZoom: 18
            }),
            terrain: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri WorldPhysical',
                maxZoom: 18
            }),
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap',
                maxZoom: 18
            })
        };

        // إعداد الخريطة الافتراضية
        currentLayer = baseLayers.satellite;
        currentLayer.addTo(map);

        // إضافة علامات مزارع المانجو
        function addMangoFarms() {
            clearMarkers();
            
            mangoRegions.forEach(region => {
                const mangoIcon = L.divIcon({
                    html: '<i class="fas fa-seedling" style="color: #fb923c; font-size: 20px;"></i>',
                    iconSize: [30, 30],
                    className: 'mango-marker'
                });

                const marker = L.marker([region.location.lat, region.location.lng], { icon: mangoIcon })
                    .bindPopup(createMangoPopup(region))
                    .addTo(map);
                
                markers.push(marker);

                // إضافة دائرة لتوضيح نطاق المزرعة
                const circle = L.circle([region.location.lat, region.location.lng], {
                    color: '#fb923c',
                    fillColor: '#fb923c',
                    fillOpacity: 0.2,
                    radius: Math.sqrt(region.area) * 100
                }).addTo(map);
                
                markers.push(circle);
            });

            updateRegionsGrid();
        }

        // إضافة علامات الأسواق
        function showMarkets() {
            marketCenters.forEach(market => {
                const marketIcon = L.divIcon({
                    html: '<i class="fas fa-store" style="color: #8b5cf6; font-size: 18px;"></i>',
                    iconSize: [25, 25],
                    className: 'market-marker'
                });

                const marker = L.marker([market.location.lat, market.location.lng], { icon: marketIcon })
                    .bindPopup(createMarketPopup(market))
                    .addTo(map);
                
                markers.push(marker);
            });
        }

        // إنشاء محتوى النافذة المنبثقة لمزارع المانجو
        function createMangoPopup(region) {
            return `
                <div class="custom-popup">
                    <div class="popup-title">
                        <i class="fas fa-seedling"></i>
                        ${region.name}
                    </div>
                    <div class="popup-content">
                        <div class="popup-detail">
                            <strong>المساحة:</strong> 
                            <span class="popup-highlight">${region.area} فدان</span>
                        </div>
                        <div class="popup-detail">
                            <strong>الإنتاج:</strong> 
                            <span class="popup-highlight">${region.production} طن</span>
                        </div>
                        <div class="popup-detail">
                            <strong>عدد المزارع:</strong> 
                            <span class="popup-highlight">${region.farms} مزرعة</span>
                        </div>
                        <div class="popup-detail">
                            <strong>الإنتاجية:</strong> 
                            <span class="popup-highlight">${region.yield} طن/فدان</span>
                        </div>
                        <div class="popup-detail">
                            <strong>أصناف المانجو:</strong> 
                            <span class="popup-highlight">${region.varieties.join(', ')}</span>
                        </div>
                        <div class="popup-detail">
                            <strong>نظام الري:</strong> 
                            <span class="popup-highlight">${region.irrigationType}</span>
                        </div>
                        <div class="popup-detail">
                            <strong>حالة الإنتاج:</strong> 
                            <span class="popup-highlight">${region.status}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // إنشاء محتوى النافذة المنبثقة للأسواق
        function createMarketPopup(market) {
            return `
                <div class="custom-popup">
                    <div class="popup-title">
                        <i class="fas fa-store"></i>
                        ${market.name}
                    </div>
                    <div class="popup-content">
                        <div class="popup-detail">
                            <strong>النوع:</strong> 
                            <span class="popup-highlight">${market.type}</span>
                        </div>
                        <div class="popup-detail">
                            <strong>السعة:</strong> 
                            <span class="popup-highlight">${market.capacity}</span>
                        </div>
                        <div class="popup-detail">
                            <strong>موسم الذروة:</strong> 
                            <span class="popup-highlight">يونيو - سبتمبر</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // رسم الطريق الصحراوي
        function drawDesertRoad() {
            const roadCoords = mangoRegions.map(region => [region.location.lat, region.location.lng]);
            
            const road = L.polyline(roadCoords, {
                color: '#ef4444',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 5'
            }).addTo(map);
            
            road.bindPopup(`
                <div class="custom-popup">
                    <div class="popup-title">
                        <i class="fas fa-road"></i>
                        طريق مصر الإسكندرية الصحراوي
                    </div>
                    <div class="popup-content">
                        <div class="popup-detail"><strong>الطول:</strong> 156 كيلومتر</div>
                        <div class="popup-detail"><strong>الحالة:</strong> ممتازة</div>
                        <div class="popup-detail"><strong>عدد الحارات:</strong> 4 حارات</div>
                        <div class="popup-detail"><strong>مزارع المانجو:</strong> 184 مزرعة</div>
                    </div>
                </div>
            `);
        }

        // تحديث شبكة المناطق
        function updateRegionsGrid() {
            const grid = document.getElementById('regionsGrid');
            grid.innerHTML = '';

            mangoRegions.forEach(region => {
                const productivity = (region.production / region.area).toFixed(1);
                const statusClass = region.status === 'ممتاز' ? 'status-excellent' : 
                                  region.status === 'جيد' ? 'status-good' : 'status-average';
                
                const progressPercentage = Math.min((region.yield / 6.0) * 100, 100);

                const card = document.createElement('div');
                card.className = 'region-card';
                card.innerHTML = `
                    <div class="region-header">
                        <div class="region-title">
                            <i class="fas fa-seedling" style="color: #fb923c;"></i>
                            ${region.name}
                        </div>
                        <div class="region-status ${statusClass}">
                            ${region.status}
                        </div>
                    </div>
                    <div class="region-details">
                        <div class="detail-row">
                            <span class="detail-label">المساحة:</span>
                            <span>${region.area} فدان</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">الإنتاج الإجمالي:</span>
                            <span>${region.production} طن</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">عدد المزارع:</span>
                            <span>${region.farms} مزرعة</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">الإنتاجية:</span>
                            <span>${region.yield} طن/فدان</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">أصناف المانجو:</span>
                            <span>${region.varieties.join(', ')}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">نظام الري:</span>
                            <span>${region.irrigationType}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <small style="color: rgba(255,255,255,0.7); margin-top: 5px; display: block;">
                            كفاءة الإنتاج: ${progressPercentage.toFixed(0)}%
                        </small>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    map.setView([region.location.lat, region.location.lng], 14);
                });
                
                grid.appendChild(card);
            });
        }

        // تحديث نوع الخريطة
        function updateMapType() {
            const mapType = document.getElementById('mapType').value;
            
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            
            currentLayer = baseLayers[mapType];
            currentLayer.addTo(map);
            
            if (mapType === 'hybrid') {
                const roadsLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    opacity: 0.5
                });
                roadsLayer.addTo(map);
            }
        }

        // مسح جميع العلامات
        function clearMarkers() {
            markers.forEach(marker => {
                map.removeLayer(marker);
            });
            markers = [];
        }

        // مسح الخريطة
        function clearMap() {
            clearMarkers();
        }

        // تحديث الخريطة
        function updateMap() {
            showLoading();
            
            setTimeout(() => {
                updateMapType();
                const displayOption = document.getElementById('displayOptions').value;
                
                if (displayOption === 'mango_farms' || displayOption === 'all') {
                    addMangoFarms();
                }
                if (displayOption === 'markets' || displayOption === 'all') {
                    showMarkets();
                }
                
                hideLoading();
                updateStats();
            }, 2000);
        }

        // تحليل منطقة المانجو
        function analyzeMangoRegion() {
            showLoading();
            
            setTimeout(() => {
                hideLoading();
                updateAnalysisData();
                alert('تم إجراء تحليل شامل لمناطق إنتاج المانجو. تم تحديث البيانات والإحصائيات.');
            }, 3000);
        }

        // تحديث بيانات التحليل
        function updateAnalysisData() {
            const totalProduction = mangoRegions.reduce((sum, region) => sum + region.production, 0);
            const totalArea = mangoRegions.reduce((sum, region) => sum + region.area, 0);
            const totalFarms = mangoRegions.reduce((sum, region) => sum + region.farms, 0);
            const avgYield = (totalProduction / totalArea).toFixed(1);

            document.getElementById('totalProduction').textContent = totalProduction.toLocaleString();
            document.getElementById('farmArea').textContent = totalArea.toLocaleString();
            document.getElementById('avgYield').textContent = avgYield;
            document.getElementById('farmsCount').textContent = totalFarms;
        }

        // البحث عن موقع
        function searchLocation() {
            const searchTerm = document.getElementById('searchLocation').value.toLowerCase();
            const foundRegion = mangoRegions.find(region => 
                region.name.toLowerCase().includes(searchTerm)
            );
            
            if (foundRegion) {
                map.setView([foundRegion.location.lat, foundRegion.location.lng], 14);
                
                const marker = markers.find(m => 
                    m.getLatLng && 
                    Math.abs(m.getLatLng().lat - foundRegion.location.lat) < 0.01
                );
                
                if (marker && marker.openPopup) {
                    marker.openPopup();
                }
            } else {
                alert('لم يتم العثور على المنطقة المطلوبة');
            }
        }

        // الحصول على الموقع الحالي
        function getCurrentLocation() {
            if (navigator.geolocation) {
                showLoading();
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        map.setView([lat, lng], 15);
                        
                        const userIcon = L.divIcon({
                            html: '<i class="fas fa-user-location" style="color: #ef4444; font-size: 24px;"></i>',
                            iconSize: [30, 30],
                            className: 'user-marker'
                        });
                        
                        const userMarker = L.marker([lat, lng], { icon: userIcon })
                            .bindPopup('موقعك الحالي')
                            .addTo(map);
                        
                        markers.push(userMarker);
                        hideLoading();
                    },
                    (error) => {
                        hideLoading();
                        alert('لا يمكن تحديد موقعك الحالي');
                    }
                );
            } else {
                alert('المتصفح لا يدعم خدمة تحديد المواقع');
            }
        }

        // تحديث الإحصائيات
        function updateStats() {
            const totalFarms = mangoRegions.reduce((sum, region) => sum + region.farms, 0);
            const accuracy = Math.floor(Math.random() * 5 + 90);
            const activeRegions = mangoRegions.length;
            const marketCentersCount = marketCenters.length;

            document.getElementById('totalMangoFarms').textContent = totalFarms;
            document.getElementById('analysisAccuracy').textContent = accuracy + '%';
            document.getElementById('activeRegions').textContent = activeRegions;
            document.getElementById('marketCenters').textContent = marketCentersCount;
        }

        // عرض وإخفاء شاشة التحميل
        function showLoading() {
            document.getElementById('loadingPanel').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingPanel').style.display = 'none';
        }

        // إعداد مستمعي الأحداث
        document.getElementById('mapType').addEventListener('change', updateMapType);
        document.getElementById('displayOptions').addEventListener('change', () => {
            clearMarkers();
            updateMap();
        });
        
        document.getElementById('searchLocation').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchLocation();
            }
        });

        // تهيئة الخريطة
        function initializeMap() {
            drawDesertRoad();
            addMangoFarms();
            showMarkets();
            updateRegionsGrid();
            updateAnalysisData();
            
            // تعديل حدود الخريطة لتشمل جميع المواقع
            const bounds = L.latLngBounds(mangoRegions.map(region => [region.location.lat, region.location.lng]));
            map.fitBounds(bounds, { padding: [50, 50] });
            
            // إضافة مقياس المسافة
            L.control.scale({ 
                position: 'bottomleft', 
                metric: true, 
                imperial: false 
            }).addTo(map);
            
            updateStats();
        }

        // بدء تشغيل الخريطة
        initializeMap();
        
        // تحديث تلقائي للبيانات كل دقيقة (محاكاة البيانات الحية)
        setInterval(() => {
            console.log('تحديث تلقائي لبيانات مزارع المانجو...');
            updateStats();
            
            // تحديث بيانات الإنتاج بشكل عشوائي طفيف لمحاكاة البيانات الحية
            mangoRegions.forEach(region => {
                const variation = (Math.random() - 0.5) * 0.1;
                region.yield = Math.max(4.0, Math.min(6.5, region.yield + variation));
                region.production = Math.round(region.area * region.yield);
            });
            
            updateAnalysisData();
        }, 60000);

        // إضافة تأثيرات تفاعلية للعناصر
        document.addEventListener('DOMContentLoaded', () => {
            // إضافة تأثير hover للبطاقات
            const cards = document.querySelectorAll('.stat-card, .region-card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-10px) scale(1.02)';
                });
                
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0) scale(1)';
                });
            });
        });
    </script>

</body>
</html>
